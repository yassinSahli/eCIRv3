### Vulnerability Finding: TLS Heartbeat Memory Disclosure (Heartbleed - CVE-2014-0160)

1. IR Report -P2  Heartbleed (TLS Heartbeat) — Memory Disclosure
**Capture / Lab File:** `heart.pcap`  
**Date Identified:** 07/10/2025  
**Analyst:** Mr. Yassine SAHLI

---

## Description

Analysis of the provided `heart.pcap` reveals TLS Heartbeat messages where the **requested payload length** is significantly larger than the **actual payload sent** by the client — the classic indicator of a Heartbleed (CVE-2014-0160) attempt. In the capture the attacker requests `0x4000` (16384) bytes while sending only a small payload (for example `"A"`). A vulnerable OpenSSL implementation that fails to validate `payload_length` may respond by returning memory adjacent to the heartbeat buffer (heap contents), leaking sensitive data such as session cookies, usernames, or even private key material.

To detect this activity on the wire with Snort, two detection approaches were implemented:

1. **Request-based (pcap-specific / brittle)** — matches the exact Heartbeat request observed in the pcap (includes TLS record header + heartbeat payload length `40 00` = 16384).  
```
alert tcp $EXTERNAL_NET any -> $HOME_NET 443 (msg:"Potential Heartbleed attack"; flow:to_server,established; content:"|18 03 02 00 03 01 40 00|"; rawbytes; isdataat:!1,relative; sid:1000004; rev:1;)
```


- This rule looks for a specific TLS record (type 0x18 = Heartbeat) and the `payload_length` field set to `0x4000`. It reliably matches the exact sample but is brittle to variations (different TLS versions, different requested lengths, different record framing).

2. **Response-based (heuristic / more reliable)** — flags unusually large TLS Heartbeat responses from servers, which is the symptomatic behavior of a vulnerable server returning more data than expected:
```
alert tcp $EXTERNAL_NET any -> $HOME_NET 443 (msg:"Potential Heartbleed attack - Response-based"; flow:to_server,established; content:"|18 03|"; rawbytes; depth:2; byte_test:1, &, 3, 0, relative; byte_test:2, >, 200, 3, relative, big; sid:1000005; rev:1;)
```

- `content:"|18 03|"` anchors to TLS record type (Heartbeat) + major version byte region.
- First `byte_test` verifies TLS version bits as a sanity check.
- Second `byte_test` inspects the TLS record length (2 bytes, big endian) and alerts when the length is suspiciously large (`> 200` bytes in this example), indicating a large heartbeat response possibly returning leaked memory. This rule is less fingerprint-specific and catches varied exploit attempts that produce large heartbeat responses.

After adding the rules to `/etc/nsm/rules/local.rules` (or `/etc/snort/rules/local.rules`), the ruleset was updated and tested by replaying `heart.pcap` through Snort:

```
# sudo rule-update
# sudo snort -q -A console --daq pcap -c /etc/nsm/securityonion-eth0/snort.conf -k none -r PCAPs/heart.pcap
```


The response-based rule produced alerts corresponding to the large heartbeat responses in the capture.

---

## Impact

- **Remote memory disclosure:** Successful exploitation can leak sensitive memory contents (session tokens, credentials, private keys).  
- **Silent exfiltration:** Attack requires no authentication and leaves no server-side logs; evidence exists only in network captures.  
- **High privacy/secret exposure risk:** Repeated exploitation can extract large amounts of memory, including private key material usable for session decryption or impersonation.

Overall risk: **High** for services running vulnerable OpenSSL versions (OpenSSL 1.0.1 through 1.0.1f inclusive).

---

## Evidence

1. Wireshark/Tcpdump filter showing TLS Heartbeat records: `ssl.record.content_type == 24`.  
   ![[Pasted image 20251007172724.png]]

2. Heartbeat request bytes showing `40 00` (0x4000 = 16384) payload length field in the request header.  
   ![[Pasted image 20251007172739.png]]

3. Observed server response with an unusually large Heartbeat payload (response length matches request length, indicating returned memory).  
   ![[Pasted image 20251007173603.png]]

4. Snort `local.rules` entries containing the request-based rule (`sid:1000004`) and response-based rule (`sid:1000005`) and console output showing triggered alerts when replaying `heart.pcap`.  
   ![[Pasted image 20251007173603.png]]

---

## MITRE ATT&CK Mapping

- **Discovery / Collection** — **T1056** (Credential Harvesting) — Heartbleed may expose credentials in memory.  
- **Credential Access** — **T1552** (Unsecured Credentials) — memory disclosure can reveal stored secrets.  
- **Impact** — **T1537** (Exfiltration Over Alternative Protocol) — exfiltration via protocol misuse (heartbeat).

(Heartbleed is primarily a memory-disclosure vulnerability rather than a classic exploit leading directly to code execution; mapping emphasizes credential/data exposure techniques.)

---

## Recommendation

**Immediate**
- **Identify and isolate** hosts that produced large Heartbeat responses in the network capture and treat as potentially compromised/confidential-data-exposed.  
- **Collect forensic evidence**: preserve pcaps, IDS logs, and capture server memory if feasible.

**Remediation**
- **Patch OpenSSL immediately** on affected systems to versions where CVE-2014-0160 is fixed (apply vendor-recommended updates or upgrade OpenSSL to a patched release).  
- If patching is not immediately possible, **disable TLS Heartbeat (RFC 6520)** support via configuration or firewall rules that filter TLS Heartbeat records.

**Mitigation**
- **Rotate secrets**: Replace any potentially exposed credentials, session keys, and certificates (including private keys) that may have been in memory at the time of exploitation. Reissue TLS certificates if private keys may have been exposed.  
- **Hunt for suspicious activity**: Search historical pcaps and IDS logs for large heartbeat responses and for subsequent suspicious access that could indicate credential reuse.

**Detection / Hardening**
- Keep Snort/IDS signatures updated for Heartbleed indicators; use the response-based heuristic rule to detect variant exploitation attempts.  
- Implement TLS best practices: strong, modern TLS stacks, disable legacy/unsupported protocol versions, and monitor for unusual TLS record sizes.  
- Use network segmentation and limit exposure of TLS services to necessary clients only.

---

## Rule Tuning Notes & Caveats

- The request-based rule (exact byte sequence) is **fragile** — attackers can vary TLS versions, heartbeat record framing, or requested length to bypass it. Use only for lab-specific detection or to catch exact observed samples.  
- The response-based heuristic is **more robust**, but can produce false positives (e.g., legitimate servers that return large TLS records for benign reasons). Tune the `byte_test` threshold (`> 200`) to match baseline traffic and reduce false positives. Consider correlating heartbeat-large-response alerts with:
  - Short preceding heartbeat request (small actual payload vs large declared length), and/or
  - Multiple repeated heartbeat requests from the same source (attackers often repeat requests to harvest more memory).
- Combine network detection with **endpoint checks** (patch level, process monitoring) and **certificate/private-key rotation** where exposure is suspected.

---

**Severity:** High  
**CVSSv3.1 Score (approx):** 8.6 (High — remote unauthenticated memory disclosure with potential leakage of sensitive keys and credentials)

---
