### Vulnerability Finding: SMB Buffer Overflow / EternalBlue Exploitation Detected

1. IR Report -P1  SMB Buffer Overflow (EternalBlue) — Remote Code Execution
**Capture / Lab File:** `eternalblue.pcap`  
**Date Identified:** 07/10/2025  
**Analyst:** Mr. Yassine SAHLI

---

## Description

Analysis of the provided `eternalblue.pcap` shows an exploitation attempt targeting SMB (TCP/445) against a Windows 7 host. The capture contains the classic **buffer overflow injection** payload — a long sequence of `A` characters (ASCII `0x41`) used to overflow the vulnerable SMBv1 request — followed by traffic consistent with a successful post-exploitation Windows shell being spawned.  

To detect the exploit on the wire, a Snort rule was created that searches for the characteristic overflow pattern in SMB packets (hex `41` repeated for the injection length observed). The detection rule (added to `local.rules`) is:

```
alert tcp $EXTERNAL_NET any -> $HOME_NET 445 (msg:"Buffer overflow activity over SMB (EternalBlue)"; content:"|4141414141... (1389 bytes of 41) ...4141|"; sid:1000002; rev:1; classtype:attempted-admin;)
```


**Note:** In practice paste the exact hex pattern observed (in this lab the overflow payload corresponded to 1389 `A` characters -> `41` repeated 1389 times). For example, the rule content was constructed by converting the `A`-string to hex via:

```
# echo "copy-paste all the As here" | wc -m
# python -c 'print("41" * 1389)'
```


and embedding the resulting hex string inside the `content:"|...|"` buffer above.

After adding the rule to `/etc/nsm/rules/local.rules` (or `/etc/snort/rules/local.rules` depending on deployment), the ruleset was updated and the pcap replayed through Snort for verification:

```
# sudo rule-update
# sudo snort -q -A console --daq pcap -c /etc/nsm/securityonion-eth0/snort.conf -k none -r PCAPs/eternalblue.pcap
```


The `-k none` option was used to disable checksum validation for the lab replay.

---

## Impact

- **Remote Code Execution (RCE):** Successful exploitation of EternalBlue leads to remote code execution on vulnerable SMBv1 Windows hosts.  
- **Shell Access / Lateral Movement:** The attacker obtained a Windows shell in the capture — enabling command execution, credential theft, lateral movement, or deployment of additional payloads (e.g., ransomware/C2 implant).  
- **High operational impact:** Compromise of a Windows host can lead to domain-wide compromise if privileged credentials or lateral movement opportunities are leveraged.

Overall risk: **Critical / High** for Windows environments where SMBv1 is enabled.

---

## Evidence

1. tcpdump ASCII output showing the long `AAAAA...` injection point (buffer overflow payload) inside SMB traffic to port 445.  
   ![[Pasted image 20251007170748.png]]

2. Count of injected `A` characters used for the overflow (`1389` As).  
   ![[Pasted image 20251007171156.png]]

3. Conversion of `A`-string to hex (`41` repeated 1389 times) used as the Snort rule content.  
   ![[Pasted image 20251007171250.png]]

4. local.rules entry showing the buffer-overflow detection rule insertion.  
   ![[Pasted image 20251007171406.png]]

5. Snort console output after replaying `eternalblue.pcap` showing the alert(s) triggered by the rule.  
   ![[Pasted image 20251007171812.png]]

6. Post-exploitation traffic in the pcap consistent with an interactive Windows shell session (commands/responses observed in SMB/other channels) — corroborates successful exploitation and shell access.

---

## MITRE ATT&CK Mapping

- **Initial Access** — **T1190** (Exploit Public-Facing Application) — exploitation of SMBv1 vulnerability (EternalBlue).  
- **Execution** — **T1059** (Command and Scripting Interpreter) — attacker gained shell and executed commands.  
- **Lateral Movement** — **T1021** (Remote Services) — use of SMB/remote exploitation to move laterally.  
- **Persistence / Defense Evasion** — **T1547 / T1070** (possible follow-up actions after RCE, dependent on observed artifacts).

---

## Recommendation

**Immediate**
- **Isolate affected host(s)** from the network (segment/quarantine) to prevent further lateral movement and data exfiltration.  
- **Capture forensic evidence** from the compromised host(s): memory image, suspicious processes, running services, and relevant event logs (Windows Event Logs, Sysmon if present). Preserve pcap and IDS logs.

**Remediation**
- **Patch / Remove SMBv1:** Immediately apply vendor patches that mitigate EternalBlue (Microsoft patches for MS17-010) or disable SMBv1 if not required.  
- **Re-image** compromised hosts where persistence or deeper compromise is suspected (recommended over attempting incomplete remediation).  
- **Credential reset:** Reset credentials for any privileged accounts that may have been exposed; consider broader password rotation for domain/service accounts.

**Detection / Hardening**
- **Maintain Snort/IDS signatures** for EternalBlue and related exploit patterns (buffer-overflow payloads, DoublePulsar callbacks) and tune for false positives. The hex-based content rule above is effective for the exact injected pattern; consider supplementing with additional heuristics (unusually large SMB payloads, abnormal SMB command sequences).  
- **Network controls:** Block SMB (TCP/445) at the network perimeter for untrusted sources; limit SMB access to necessary internal subnets only.  
- **Hunting:** Search historical pcaps, netflow, and IDS logs for similar large SMB payloads and for subsequent beaconing or suspicious outbound connections from the victim.  
- **Endpoint monitoring:** Deploy/validate EDR capabilities to detect anomalous command execution, process injection, and known exploit artifacts. Enable Windows logging (Sysmon) to capture process creations and network connections for post-incident hunting.

---

## Detection Tuning & Rule Hardening Notes

- The sample rule uses a large, fixed-length hex payload (`41` * 1389) which is reliable for this specific PCAP but may be brittle if exploit payload length varies or is encoded/compressed. Consider adding additional rules that:
  - Alert on **unusually large SMB payloads** (excessive request sizes) directed at internal hosts.  
  - Use multiple content checks (SMB header + repeated `41` run-length) to reduce false positives. Example: require SMB header bytes preceding the overflow pattern.  
  - Combine with flow checks (`flow:established,to_server;`) and byte_test/byte_jump if needed to be more exact.

Example more-specific rule skeleton:

```
alert tcp $EXTERNAL_NET any -> $HOME_NET 445 (msg:"SMB possible overflow - large payload"; flow:established,to_server; byte_test:4,>,1000,0; content:"SMB"; nocase; sid:1000100; rev:1;)
```


---

**Severity:** High / Critical (exploit leading to RCE and shell access)  
**CVSSv3.1 Score (approx):** 9.0 (Critical — remote code execution on unpatched systems)

---
