### Vulnerability Finding: NETBIOS/SMB-DS DCERPC LSASS Exploit Rule Analysis

1. IR Report -P2  NETBIOS SMB-DS DCERPC LSASS DsRolerUpgradeDownlevelServer exploit attempt — Snort Rule Analysis  
**Rule Reviewed:** 

```
alert tcp $EXTERNAL_NET any -> $HOME_NET 445 (msg:"NETBIOS SMB-DS DCERPC LSASS DsRolerUpgradeDownlevelServer exploit attempt"; flow:to_server,established; flowbits:isset,netbios.lsass.bind.attempt; content:"|FF|SMB"; depth:4; offset:4; nocase; content:"|05|"; distance:59; content:"|00|"; within:1; distance:1; content:"|09 00|"; within:2; distance:19; classtype:attempted-admin; sid:2514; rev:7;)  
```

**Date Reviewed:** 07/10/2025  
**Analyst:** Mr. Yassine SAHLI

---

## High-level Description

This Snort rule is written to detect a **specific, multi-stage exploit fingerprint** targeting SMB over TCP (port 445) that abuses DCERPC interfaces related to LSASS (Local Security Authority Subsystem Service) — in particular the DsRole/role-related RPC operation path. The rule is conservative: it only fires for **established TCP connections to internal hosts on port 445** and **only if a prior rule set a flowbit** (`netbios.lsass.bind.attempt`), meaning it attempts to correlate an earlier suspicious DCERPC bind to LSASS with a follow-up exploit-like payload. The rule matches a tightly defined sequence of bytes in the SMB payload (SMB signature plus several content checks at precise offsets) to lower false positives and specifically identify an exploit pattern.

---

## What the rule looks for (step‑by‑step)

1. **Traffic scope / header**
   - Protocol: `tcp`.  
   - Direction: from `$EXTERNAL_NET` → `$HOME_NET` on destination TCP port `445` (SMB).  
   - Action: `alert` (log an alert, not block).

2. **Session context**
   - `flow:to_server,established;` — Only consider packets part of an established TCP session flowing to the server. This avoids matching stray or non-established packets.

3. **Correlation with prior DCERPC activity**
   - `flowbits:isset,netbios.lsass.bind.attempt;` — Requires that a previous detection set `netbios.lsass.bind.attempt` on this flow (usually from a DCERPC bind detection). This ties the alert to connections that earlier performed an RPC bind to LSASS/DCERPC interfaces, reducing false positives.

4. **SMB protocol header anchor**
   - `content:"|FF|SMB"; offset:4; depth:4; nocase;`  
     - Skips the 4-byte NetBIOS Session header (offset:4) and expects the SMB signature bytes (`0xFF 0x53 0x4D 0x42`, i.e., `\xFFSMB`) at that position. This confirms NetBIOS-less SMB-over-TCP framing.

5. **Payload/fingerprint walking**
   - `content:"|05|"; distance:59;` — After the SMB signature match, the rule looks 59 bytes further for a single byte `0x05`.  
   - `content:"|00|"; within:1; distance:1;` — Immediately after the `0x05` (1 byte distance), expect a `0x00`.  
   - `content:"|09 00|"; within:2; distance:19;` — Then 19 bytes later expect the 2-byte sequence `0x09 0x00`.  
   - These successive `distance`/`within` constraints are walking fields inside the SMB/DCERPC payload to match the exploited RPC call structure or specific parameter values used by the exploit.

6. **Classification and identifiers**
   - `classtype:attempted-admin;` — Classifies as an attempt to gain administrative capabilities.  
   - `sid:2514; rev:7;` — Signature ID and revision.

---

## Intent and detection rationale

- The rule is designed to **detect an exploit attempt targeting DCERPC/LSASS RPC endpoints** by matching both protocol framing (SMB signature at the expected offset) and specific byte-patterns deeper in the SMB/DCERPC payload that correspond to the exploit’s call/parameters.
- Requiring `flowbits:isset,netbios.lsass.bind.attempt` ensures the rule only triggers when a suspicious DCERPC bind sequence was previously observed, thereby **correlating bind + exploit** behavior and greatly reducing false positives from benign SMB traffic.
- The use of precise `distance` / `within` offsets indicates the authors reverse-engineered the packet layout of the exploit to match fixed fields rather than simple text strings — a low‑noise, high‑confidence approach for known exploit variants.

---

## Evidence you'd expect to find if the rule fires

- An established TCP SMB session (port 445) where earlier SMB/DCERPC bind traffic targeted LSASS interfaces (flowbit set).  
- Packet(s) containing the NetBIOS-less SMB header (`\xFFSMB`) followed by the exact byte-sequence pattern the rule walks to (the `0x05`, `0x00`, `0x09 0x00` pattern at the specified offsets).  
- Potential follow-up behavior after the matched packet: abnormal DCERPC responses, attempts to perform privileged RPC methods, or lateral movement indicators (new SMB sessions, authentication attempts, file transfer, command execution).

---

## MITRE ATT&CK Mapping

- **Initial Access / Exploitation** — **T1190** (Exploit Public-Facing Application) — targeted exploitation of a network service.  
- **Execution / Privilege Escalation** — **T1068/T1060** (exploitation leading to elevated privileges or access to LSASS secrets).  
- **Credential Access** — **T1003 / T1003.001** (LSASS credential dumping) — if exploit leads to LSASS access or memory read.  
- **Lateral Movement** — **T1021** (Remote Services) — post-exploit use of SMB/DCERPC to pivot.

---

## Risks & Impact

- **High-risk**: If the rule corresponds to a true exploit, the attacker may be attempting to execute privileged RPC calls or extract secrets from LSASS, potentially leading to domain compromise.  
- **False positives** are mitigated by the flowbit dependency and strict offset matching, but any mismatch between expected packet layout and real exploit variants could cause misses (false negatives).

---

## Recommendations

**Immediate**
- Investigate the flow that triggered the alert: capture full pcap for the TCP session, identify the external source IP, and isolate the affected server if exploitation appears successful.  
- Check for signs of post-exploitation activity on the host (new processes, suspicious service behavior, event logs, network connections).

**Forensics**
- Acquire memory/volatile data from the suspected host (if feasible) and preserve SMB/PCAP evidence. Inspect Windows event logs, Sysmon (if present), and authentication logs for credential theft or lateral movements.

**Remediation & Hardening**
- Apply vendor patches for SMB/DCERPC-related vulnerabilities promptly. Disable legacy SMB/NetBIOS services if not required.  
- Limit exposure of SMB (block TCP/445 at the perimeter for untrusted networks) and restrict SMB to necessary internal subnets via firewall rules.  
- Enforce least-privilege and monitor RPC/LSASS access.

**Detection Tuning**
- Ensure the flowbit `netbios.lsass.bind.attempt` is implemented and tuned correctly (the preceding rule that sets it must be present and accurate).  
- Consider complementary rules: detect suspicious DCERPC binds, anomalous SMB command sequences, or unusually large/structured DCERPC payloads.  
- Log and correlate with EDR alerts (process creation, credential dumping tools) to confirm compromise.

---

## Caveats & Limitations

- The rule is **signature-specific**: it targets a known exploit fingerprint. Variants that change argument ordering, padding, or offsets may bypass this rule.  
- The rule relies on a **prior flowbit** — if that initial detection is missed (e.g., packet loss, off-path capture), this rule will not fire even if the exploit later appears.  
- Rules that use fixed `distance`/`within` offsets assume stable packet structure; protocol variations (different SMB dialects, fragmentation) can affect matching.

---

**Severity (if triggered and validated):** High — potential attempted administrative compromise via DCERPC / LSASS exploitation.  
**Suggested follow-up priority:** Immediate investigation and host isolation until the incident is triaged.
