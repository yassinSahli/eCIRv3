### **Analyze the Provided PCAP Files and Develop Your Own Rules (Level: Beginner)**
By opening Sofacy.pcap in Wireshark, the first thing we notice is two (2) DNS queries and the respective DNS responses.
![[Pasted image 20250925213813.png]]
Let’s create a Suricata rule to detect those two (2) C2 domains : 
![[Pasted image 20250925214014.png]]
![[Pasted image 20250925214107.png]]

**Let’s continue with the Citi.pcap file**. If you are unfamiliar with Citi, Citi is a global bank. By opening the Citi.pcap in Wireshark, the first thing we notice is a phishy-looking DNS query (note that online.citi.com is a legitimate URL).

![[Pasted image 20250925214141.png]]
```alert dns $HOME_NET any -> any any (msg:"Possible Citi Phishing Attempt Observed in DNS Query "; dns_query; content:"online.citi.com"; nocase; isdataat:1,relative; sid:3; rev:1;)```

isdataat:1,relative will inform us if any data exist after online.citi.com. There shouldn’t be any data after it. If data are identified after online.citi.com, then, we are dealing with a phishing URL, similar to the one you can see in the PCAP file above (inside the red rectangle)


**By opening Qadars.pcap in Wireshark,** the first thing we notice is a DNS query and a DNS response regarding susana24.com. Then, we notice TLS traffic initiating.

![[Pasted image 20250925214927.png]]
Let’s focus on the TLS certificate this time and try to create a rule based on the CN portion of it (susana24.com).
```alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"TROJAN Activity Observed Malicious SSL Cert (Qadars CnC)"; flow:established,to_client; tls_cert_subject; content:"CN=susana24.com"; classtype:trojan activity; sid:4; rev:1;)```

**Now, it’s time to analyze the 7ev3n.pcap** To learn more about the 7ev3n ransomware, refer to the following link https://www.vmray.com/cyber-security-blog/7ev3n-honet-ransomware-rest-us/. 
We’ll develop a Suricata rule based on our analysis of the 7ev3n.pcap file, considering that what we see inside the PCAP is malicious. 
By opening 7ev3n.pcap in Wireshark and filtering so that we can see HTTP traffic only, the first thing we notice is this curious-looking request. Let’s follow the whole stream.

![[Pasted image 20250925220336.png]]
![[Pasted image 20250925220353.png]]

```alert http $HOME_NET any -> $EXTERNAL_NET any (msg:" TROJAN 7ev3n Ransomware CnC Checkin"; flow:established,to_server; content:"GET"; http_method; content:".php?RIGHTS="; http_uri; content:"&WIN="; http_uri; distance:0; content:"&WALLET="; http_uri; distance:0; content:"&ID="; http_uri; distance:0; content:"&UI="; http_uri; distance:0; content:"Internet|20|Explorer"; http_user_agent; depth:17; isdataat:!1,relative; http_header_names; content:!"Referer"; content:!"Accept"; sid:5; rev:1;)```

```alert http $HOME_NET any -> $EXTERNAL_NET any (msg:" TROJAN 7ev3n Ransomware Encryption Activity"; flow:established,to_server; content:"GET"; http_method; content:".php?SSTART="; http_uri; content:"&CRYPTED_DATA="; http_uri; distance:0; content:"&ID="; http_uri; distance:0; content:"&FILES="; http_uri; distance:0; content:"&UI="; http_uri; distance:0; content:"Internet|20|Explorer"; http_user_agent; depth:17; isdataat:!1,relative; http_header_names; content:!"Referer"; content:!"Accept"; sid:6; rev:1;)```

depth:17; isdataat:!1,relative; is looking to see if there are any data after the last “r” of the “Internet Explorer” string, ensuring that the User Agent field only contains “Internet Explorer”. http_header_names; content:!"Referer"; content:!"Accept"; is leveraging the lack of usual headers for detection purposes.

**Finally, let’s analyze the Malicious_document.pcap**
Typically, malicious Office documents rely on macro execution, embedded objects, or exploits to deliver a payload onto the victim machine. In such cases, the URI can be so characteristic as to be used as solid rule content. The same applies for the User-Agent. By opening the Malicious_document.pcap in Wireshark, the first thing we notice is this curious-looking HTTP request.
![[Pasted image 20250925220614.png]]
```alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Malicious Document Retrieving Payload"; flow:established, to_server; content:".exe?q=";fast_pattern; content: "Microsoft BITS/";http_user_agent; depth:15;pcre:"/\.exe\?q=[0-9]{3,5}$/U"; http_header_names; content :! "Referer";sid:7; rev:1;)```

flow:established,to_server; is used since we are dealing with TCP and the directionality is towards the malicious server. We won’t focus on the curious-looking HEAD HTTP method so that we can catch variations. fast_pattern; is used so that the Suricata engine “focuses more” on the .exe?q= content ('User-Agent:' will be a match very often, but .exe?q= appears less often in network traffic). pcre:"/\.exe\?q=[0-9]{3,5}$/U"; means the sensor should match every time it observes three to five numbers after q=. Finally, we are once again leveraging the lack of usual headers for detection purposes.

