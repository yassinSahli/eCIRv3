## **Scenario**

The organization you work for is considering deploying Suricata to enhance its traffic inspection capabilities. The IT Security manager provided you with some Suricata rules to get familiar with their structure. He also provided you with PCAP files containing malicious traffic so that you can experiment with writing Suricata detection rules.

A test instance of Suricata has already been set up and is waiting for you!

## **Learning Objectives**

The learning objective of this lab is not only to get familiar with the detection capabilities of Suricata but also to learn effective rule writing of Suricata rules.

Specifically, you will learn how to use Suricata’s capabilities in order to:

- Have better visibility over a network
- Respond to incidents timely and effectively
- Proactively hunt for threats

## **Introduction to Suricata Rules**

### **What is a Suricata Rule?**

![[Pasted image 20250911222047.png]]
Rules are essentially instructions to the Suricata engine to look for specific markers in network traffic that we want to be notified about if they are seen.

Rules are not always oriented towards detecting malicious traffic. Rules can also be written to provide blue team members with actionable and/or contextual information regarding activity that is occurring on a network.

Rules can be as specific or as broad as we want them to be. Finding the perfect balance is important in order, for example, to be able to detect variations of a given malware but also avoid false positives. They can be seen as a big AND statement (multiple contents are specified, and the rule will trigger an alert if and only if all of these contents are seen in the passing traffic).

Threat intelligence and infosec communities usually offer critical information based on which rules are developed.

Each active rule consumes some of the host’s CPU and memory. Specific guidelines exist to assist effective Suricata rule writing.

Basic Rule Structure:

```
action protocol from_ip port -> to_ip port (msg:"we are under attack by X"; content:"something"; content:"something else"; sid:10000000; rev:1;)
```

| Rule Portion                | Description                                                            |
| --------------------------- | ---------------------------------------------------------------------- |
| **Header**                  | Includes action, protocol, IPs, ports, and directionality.             |
| **Rule Message & Contents** | Message for analysts; contents are key traffic portions for detection. |
| **Rule Metadata**           | Tracks modifications (e.g., sid: unique identifier; rev: version).     |

### **Dive into the Header**

- **Action**: Tells Suricata what to do if contents match.
    - Alert: Generate alert and log matching packets, but let traffic through.
    - Log: Log traffic (no alert).
    - Pass: Ignore the packet and allow it through.
    - Drop: If in IPS mode, drop the packet.
    - Reject: IDS will send TCP RST packet(s).
- **Protocol**: Can be tcp, udp, icmp, ip, http, tls, smb, dns.
- **Directionality**:
    - Rule Host Variables: $HOME_NET (internal networks from suricata.yaml), $EXTERNAL_NET (anything not in $HOME_NET).
    - Rule Direction: Arrow indicates flow.
        - Outbound: $HOME_NET any -> $EXTERNAL_NET any
        - Inbound: $EXTERNAL_NET any -> $HOME_NET any
        - Bidirectional: $EXTERNAL_NET any <> $HOME_NET any
- **Rule Ports**: Ports for evaluation.
    - Examples: alert tcp $HOME_NET any -> $EXTERNAL_NET 4444
    - Use variables like $FTP_PORTS from suricata.yaml.
    - Negation: !80
    - Ranges: [1024:], [80,800,6667:6680,!6672]

Example: For a DNS query PCAP, the header is alert dns $HOME_NET any -> any any (uses "any" to include internal resolvers).

### **Dive into Rule Message & Contents**

- **Rule Message**: Arbitrary text that appears when triggered. Include malware architecture, family, and action for clarity.
- **Flow**: Declares originator/responder. Use "established" for TCP.
    - Examples: flow:established,to_server|to_client; (from_server/from_client also usable).
    - For UDP: flow:to_server;
- **Dsize**: Matches packet payload size (TCP/UDP only, based on TCP segment length, not total packet; Wireshark filter: tcp.len).
    - Examples: dsize:312; dsize:300<>400;
- **Rule Content**: Unique values for detection. Use hex for special characters.
    - Examples: content:"some thing"; content:"some|20|thing"; content:"User-Agent|3a 20|";
- **Rule Buffers**: Speed up searches by limiting to protocol-specific areas (e.g., http_method, http_uri). See [https://suricata.readthedocs.io/en/latest/rules/http-keywords.html](https://suricata.readthedocs.io/en/latest/rules/http-keywords.html).
    - Example transformation: content:"POST"; http_method; content:"/trigger.php"; http_uri;
- **Rule Options**: Modifiers for precision.
    - nocase: Case-insensitive match.
    - offset: Start matching at position (use with depth).
        - Example: content:"whatever"; offset:5;
    - distance: Look n bytes after previous match (use with within).
        - Example: content:"whatever"; content:"something"; distance:5;
    - Examples: content:"whatever"; nocase; depth:9; content:"some|20|thing"; distance:0;

**Additional Examples:**

- content:"whatever"; nocase; depth:9; content:"some|20|thing"; distance:0; (Looks in first 9 bytes, then anywhere after.)
- alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"Malicious"; flow:established,to_server; dsize:45; content:"suspicious"; offset:33; (Outbound TCP, exact size, content at end.)

### **Dive into Rule Metadata**

- reference: Source of initial info (e.g., reference:url,securingtomorrow.mcafee.com/2017-11-20-dridex;).
- sid: Unique signature ID (e.g., sid:10000000;).
- revision: Rule version (e.g., rev:5;).

### **PCRE (Perl Compatible Regular Expressions)**

PCRE is powerful for complex patterns. Use /pattern/flags; (anchors ^/$ for start/end; escape special chars).

- Examples: pcre:"/something/flags"; pcre:"/^/[a-z0-9]{6}.php$/Ui"; (6 alphanumerics followed by .php, case-insensitive).
- Never write PCRE-only rules; combine with other contents.

### **Managing Suricata Rules**

- Download from: [https://rules.emergingthreats.net/open/](https://rules.emergingthreats.net/open/), [https://github.com/EmergingThreats/et-luajit-scripts](https://github.com/EmergingThreats/et-luajit-scripts), [https://github.com/ptresearch/AttackDetection](https://github.com/ptresearch/AttackDetection).
- Manage with: [https://github.com/OISF/suricata-update](https://github.com/OISF/suricata-update) (see docs).
- Study more: [https://suricata.readthedocs.io/en/latest/rules/index.html](https://suricata.readthedocs.io/en/latest/rules/index.html).

 Rules are in **/etc/suricata/rules/** (e.g., emerging-trojan.rules). 
 Use ls -lah **/etc/suricata/rules/** to list.
 
![[netriders.academy_all-courses_incident-response_lesson_03-5-intrusion-detection-by-analyzing-traffic-module-2-part-5-suricata-fundamentals-lab_ (1).png]]
## **Recommended Tools**

- Suricata
- Wireshark

## Network Configuration & Credentials

- Incident Responder’s Subnet: 172.16.69.0/24
- Suricata: 172.16.69.100
- Connection: SSH (username: elsanalyst; password: @nalyst)
    - Linux: ssh elsanalyst@172.16.69.100
    - Windows: PuTTY (Host: 172.16.69.100, Port: 22, SSH)

PCAPs: /home/elsuser/PCAPs. Transfer via cd PCAPs; sudo python -m SimpleHTTPServer 80 and browse [http://172.16.69.100](http://172.16.69.100).

## Running Suricata and Viewing Logs (Supplemental from SURICATA.pdf)

- **Offline Input (PCAPs)**:  
		``` sudo suricata -r PCAPs/eicar-com.pcap``` (creates eve.json, fast.log, stats.log in current dir if -l . used).
    - No checksums: ```sudo suricata -r PCAPs/eicar-com.pcap -k none -l .```
    ![[Pasted image 20250911230643.png]]
- **Live Input**: ```sudo suricata -i ens33 (IDS mode); or --pcap=ens33 -vv.
- **Logs** (in /var/log/suricata/ by default; root access needed):
    - eve.json: Recommended output (JSON alerts).
    - fast.log: Human-readable alerts.
    - stats.log: Statistics.
- **View Alerts**: ```cat eve_archived.json | jq 'select(.event_type == "alert")'```
![[Pasted image 20250911233408.png]]
- **Count Events**: ```sudo cat /var/log/suricata/eve_archived.json | jq -c '.event_type'|sort|uniq -c|sort -nr
- **EveBox**: ```sudo evebox oneshot /var/log/suricata/eve_archived.json``` (visualize alerts).
![[Pasted image 20250911235044.png]]


## Tasks

### Task 1: Analyze the Provided Suricata Rules and Describe What They Look For

Analyze these rules and explain their detection logic.

Rule 1:

```
alert dns $HOME_NET any -> any any (msg:"TROJAN X Rogue DNS Query Observed" dns_query; content:"searchcdn.gooogle.com"; isdataat:!1,relative; reference:url,threatintelprovider.com/trojanx; classtype:trojan-activity; sid:1; rev:1;)
```

Rule 2:

text

```
alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"TROJAN Z malicious SSL Cert"; flow:established,to_client; tls_cert_subject; content:"CN=uniquestring"; classtype:trojan-activity; sid:1; rev:1;)
```

### Task 2: Analyze the Provided PCAP Files and Develop Your Own Rules (Level: Beginner)

Analyze Sofacy.pcap, Citi.pcap (phishing), Qadars.pcap, 7ev3n.pcap, Malicious_document.pcap using Wireshark. Develop rules to detect malicious traffic.

### Task 3: Analyze the Provided PCAP Files and Develop Your Own Rules (Level: Intermediate)

Analyze DDoSClient.pcap and Adobe.pcap. Develop rules for complex cases.

## Solutions

### Solution for Task 1

**Rule 1 Analysis**:

- Protocol: DNS (inspects based on protocol, not port).
- Direction: Outbound from home, to any (includes internal resolvers).
- Message: Informs of rogue DNS query.
- Content: dns_query buffer for "searchcdn.gooogle.com"; isdataat:!1,relative locks match (no data after).
- Metadata: Reference, classtype, sid, rev.

**Rule 2 Analysis**:

- Protocol: TLS (inspects based on protocol).
- Direction: Inbound from external.
- Flow: Established TCP, to client.
- Content: tls_cert_subject buffer for "CN=uniquestring".
- Message/Classtype: Trojan SSL cert.

### Solution for Task 2 (Beginner Rules)

**Sofacy.pcap** (DNS queries to C2 domains):

- Rules:
    
    text
    
    ```
    alert dns $HOME_NET any -> any any (msg:"TROJAN Activity Detected DNS Query to Known Sofacy Domain 1"; dns_query; content:"drivres-update.info"; nocase; isdataat:!1,relative; sid:1; rev:1;)
    ```
    
    text
    
    ```
    alert dns $HOME_NET any -> any any (msg:"TROJAN Activity Detected DNS Query to Known Sofacy Domain 2"; dns_query; content:"softupdates.info"; nocase; isdataat:!1,relative; sid:2; rev:1;)
    ```
    
- Test: sudo ./automate_suricata.sh ../PCAPs/Sofacy.pcap (Alerts on domains).

**Citi.pcap** (Phishing DNS):

- Rule:
    
    text
    
    ```
    alert dns $HOME_NET any -> any any (msg:"Possible Citi Phishing Attempt Observed in DNS Query "; dns_query; content:"online.citi.com"; nocase; isdataat:1,relative; sid:3; rev:1;)
    ```
    
- Detects extra data after legitimate domain.
- Test: sudo ./automate_suricata.sh ../PCAPs/Citi.pcap.

**Qadars.pcap** (TLS cert):

- Rule:
    
    text
    
    ```
    alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"TROJAN Activity Observed Malicious SSL Cert (Qadars CnC)"; flow:established,to_client; tls_cert_subject; content:"CN=susana24.com"; classtype:trojan-activity; sid:4; rev:1;)
    ```
    
- Test: sudo ./automate_suricata.sh ../PCAPs/Qadars.pcap.

**7ev3n.pcap** (Ransomware checkins):

- Rules:
    
    text
    
    ```
    alert http $HOME_NET any -> $EXTERNAL_NET any (msg:" TROJAN 7ev3n Ransomware CnC Checkin"; flow:established,to_server; content:"GET"; http_method; content:".php?RIGHTS="; http_uri; content:"&WIN="; http_uri; distance:0; content:"&WALLET="; http_uri; distance:0; content:"&ID="; http_uri; distance:0; content:"&UI="; http_uri; distance:0; content:"Internet|20|Explorer"; http_user_agent; depth:17; isdataat:!1,relative; http_header_names; content:!"Referer"; content:!"Accept"; sid:5; rev:1;)
    ```
    
    text
    
    ```
    alert http $HOME_NET any -> $EXTERNAL_NET any (msg:" TROJAN 7ev3n Ransomware Encryption Activity"; flow:established,to_server; content:"GET"; http_method; content:".php?SSTART="; http_uri; content:"&CRYPTED_DATA="; http_uri; distance:0; content:"&ID="; http_uri; distance:0; content:"&FILES="; http_uri; distance:0; content:"&UI="; http_uri; distance:0; content:"Internet|20|Explorer"; http_user_agent; depth:17; isdataat:!1,relative; http_header_names; content:!"Referer"; content:!"Accept"; sid:6; rev:1;)
    ```
    
- Uses missing headers, exact User-Agent.
- Test: sudo ./automate_suricata.sh ../PCAPs/7ev3n.pcap.

**Malicious_document.pcap** (Payload retrieval):

- Rule:
    
    text
    
    ```
    alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Malicious Document Retrieving Payload"; flow:established,to_server; content:".exe?q="; fast_pattern; content:"Microsoft BITS/"; http_user_agent; depth:15; pcre:"/\\.exe\\?q=[0-9]{3,5}$/U"; http_header_names; content:!"Referer"; sid:7; rev:1;)
    ```
    
- PCRE for query params; fast_pattern optimizes.
- Test: sudo ./automate_suricata.sh ../PCAPs/Malicious_document.pcap.

### Solution for Task 3 (Intermediate Rules)

**DDoSClient.pcap** (Bot checkin):

- Rule:
    
    text
    
    ```
    alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"ET TROJAN DDoS Client Information Checkin"; flow:established,to_server; content:"Windows"; nocase; depth:7; content:"MHZ|00 00 00 00 00 00|"; distance:0; nocase; content:"|00 00 00 00 00 00|Win"; distance:0; nocase; classtype:trojan-activity; sid:8; rev:1;)
    ```
    
- Matches OS/CPU info with nulls.
- Test: sudo ./automate_suricata.sh ../PCAPs/DDoSClient.pcap.

**Adobe.pcap** (Phishing redirect):

- Rule:
    
    text
    
    ```
    alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Adobe Phising Attempt"; flow:established,to_client; content:"200"; http_stat_code; http_content_type; content:"text/html"; nocase; file_data; content:"<META HTTP-EQUIV="; nocase; within:100; content:"refresh"; distance:1; nocase; within:7; content:"self.location.replace"; nocase; distance:0; content:"window.location"; nocase; distance:0; classtype:bad-unknown; sid:9; rev:1;)
    ```
    
- Detects unusual dual redirect methods.
- Test: sudo ./automate_suricata.sh ../PCAPs/Adobe.pcap.