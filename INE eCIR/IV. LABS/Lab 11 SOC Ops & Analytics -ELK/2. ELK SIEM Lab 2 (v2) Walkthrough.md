
## **Scenario**
Your organization is evaluating the **ELK Stack (Elasticsearch, Logstash, Kibana)** as a SIEM solution. As an incident responder, you are tasked with learning ELKâ€™s capabilities, detecting attacker behaviors, and creating queries to uncover suspicious or malicious activity.
## **Learning Objectives**
1. Understand ELK stack components (Elasticsearch, Logstash, Kibana).
2. Perform searches and visualizations in Kibana.
3. Translate attacker TTPs (MITRE ATT&CK techniques) into ELK queries.
4. Detect malicious behavior such as:
    - Suspicious processes masquerading as system binaries.
    - Persistence via Windows services.
    - Code injection and privilege escalation.
    - RDP session hijacking.
    - Credential dumping via LSASS tampering.

## **Introduction to ELK**

The ELK Stack consists of:

- **Elasticsearch** â†’ NoSQL database & search engine.(indexing and storage)
- **Logstash** â†’ Collects, parses, and transforms logs before sending to Elasticsearch.
- **Kibana** â†’ Web UI for search, visualization, and dashboards.
- **Beats** (optional) â†’ Lightweight agents for log shipping from endpoints.

![[Pasted image 20251004104054.png]]

ðŸ‘‰ In a SOC environment, analysts primarily work in **Kibana** to run queries and create dashboards for detection.

On demanding/data-heavy environments, ELKâ€™s architecture can be reinforced by Kafka, RabbitMQ and Redis for buffering and resilience and by ngnix for security.
![[Pasted image 20251004104132.png]]
### **Elasticsearch**

- **Role:** Storage, indexing, and querying engine.
    
- **Type:** NoSQL database built on the **Lucene search engine** with **RESTful APIs**.
    
- **Purpose:**
    
    - Serves as the **index and query engine** of ELK.
        
    - Stores the log records processed by Logstash.
        
    - Provides powerful **search and analytics capabilities**.
        
- **Example Use:** Running advanced queries (e.g., find all failed logins in the past week).
    

---
### **Logstash**

- **Role:** Data collection, transformation, and transport pipeline.
    
- **Purpose:** Unifies data from multiple sources, normalizes it, and sends it to Elasticsearch.
    
- **Core Functions:**
    
    1. **Input** â€“ Collects log events from sources (flat files, TCP sockets, syslog, cloud services).
        
    2. **Filter** â€“ Transforms and enriches logs using plugins (e.g., parsing fields, masking sensitive data).
        
    3. **Output** â€“ Forwards normalized logs to **Elasticsearch** or other destinations.
        
- **Example Use:** Parsing Windows event logs into structured JSON fields before storing them in Elasticsearch.
    

---
### **Beats (Optional Component)**

- **Role:** Lightweight log shippers.
    
- **Purpose:** Installed on endpoints or servers to collect logs and send them to Logstash or Elasticsearch.
    
- **Example Beats:**
    
    - **Filebeat** â€“ ships log files.
        
    - **Winlogbeat** â€“ ships Windows Event Logs.
        
    - **Packetbeat** â€“ ships network traffic metadata.

---
###  **Kibana**

- **Role:** Visualization and analysis interface.
    
- **Purpose:** Allows analysts to **query Elasticsearch data** and visualize results.
    
- **Features:**
    
    - Interactive **search bar** for building queries.
        
    - **Tables, charts, and dashboards** for reporting.
        
    - Drill-down capability for **incident investigation**.
        
- **Example Use:** Creating a dashboard showing failed logins, abnormal processes, and RDP session hijacking attempts.
    

![[Pasted image 20251004104703.png]]
- Kibana searches are usually formatted as ```FieldName:SearchTerm```.
- Fields and search terms are case sensitive. 
- Boolean operators like AND, OR are supported (and are sometimes implied).
- Wildcards and free text searches can be used, but use sparingly.

## **Task 1 â€“ Explore Data & Identify Users**

1. Connect to Kibana:
    `http://172.16.73.100:5601`
2. Change time filter â†’ **Last 5 years**.
    ![[Pasted image 20251004114408.png]]
3. Run empty search â†’ add helpful fields (`event_id`, `computer_name`).
    ![[Pasted image 20251004114450.png]]
	![[Pasted image 20251004114507.png]]

âœ… Now you can see all users in the dataset.

---

## **Task 2 â€“ Create an actionable visualization**

To identify all users included in the dataset you can start by submitting an empty search, expanding Available Fields and then inspecting the event_data.User field. If you do you so will come across the below.
![[Pasted image 20251004120047.png]]
Do you notice that 500 records message? This is because, by default, results are limited to 500 records. You can change that by going to the Management tab and then clicking **Advanced Settings,** but letâ€™s create a visualization instead.
![[Pasted image 20251004120137.png]]
![[Pasted image 20251004120157.png]]
![[Pasted image 20251004120219.png]]
![[Pasted image 20251004120301.png]]
![[Pasted image 20251004120320.png]]
You can save this visualization if you like by pressing Save on your upper right and specifying a name.

---

## **Task 3 â€“ CREATE A SEARCH TO IDENTIFY FILES THAT ARE NAMED LIKE SYSTEM PROCESSES**

Malware often uses **legitimate process names** (e.g., `svchost.exe`) but runs outside `System32`.

Search:

`( event_data.Image:("*\\rundll32.exe" "*\\svchost.exe" "*\\wmiprvse.exe" "*\\wmiadap.exe" "*\\smss.exe" "*\\wininit.exe" "*\\taskhost.exe" "*\\lsass.exe" "*\\winlogon.exe" "*\\csrss.exe" "*\\services.exe" "*\\svchost.exe" "*\\lsm.exe" "*\\conhost.exe" "*\\dllhost.exe" "*\\dwm.exe" "*\\spoolsv.exe" "*\\wuauclt.exe" "*\\taskhost.exe" "*\\taskhostw.exe" "*\\fontdrvhost.exe" "*\\searchindexer.exe" "*\\searchprotocolhost.exe" "*\\searchfilterhost.exe" "*\\sihost.exe") AND event_data.Image:("*\\system32\\*" "*\\syswow64\\*" "*\\winsxs\\*") ) OR ( event_data.TargetFilename:("*\\rundll32.exe" "*\\svchost.exe" "*\\wmiprvse.exe" "*\\wmiadap.exe" "*\\smss.exe" "*\\wininit.exe" "*\\taskhost.exe" "*\\lsass.exe" "*\\winlogon.exe" "*\\csrss.exe" "*\\services.exe" "*\\svchost.exe" "*\\lsm.exe" "*\\conhost.exe" "*\\dllhost.exe" "*\\dwm.exe" "*\\spoolsv.exe" "*\\wuauclt.exe" "*\\taskhost.exe" "*\\taskhostw.exe" "*\\fontdrvhost.exe" "*\\searchindexer.exe" "*\\searchprotocolhost.exe" "*\\searchfilterhost.exe" "*\\sihost.exe") AND event_data.TargetFilename:("*\\system32\\*" "*\\syswow64\\*" "*\\winsxs\\*") )`

AND -event_data.Image is excluding the expected paths.
`event_data.TargetFilename` is used in case the file included in the event_data.Image field interacted with another file. For example, if PowerShell downloaded a file named 65536.exe you would see the below. 

event_data.Image: `C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` event_data.TargetFilename: `C:\Users\PhisedUser\AppData\Local\Temp\65536.exe`

![[Pasted image 20251012121616.png]]

---

## **TASK 4: CREATE A SEARCH TO IDENTIFY SUSPICIOUS SERVICES INTERACTING WITH AN EXECUTABLE FROM THE WINDOWS FOLDER**

When it comes to suspicious service detection the Windows Security Log Event ID 4697 and the Windows Event ID 7045 events will prove useful. The same applies for Autoruns logs.

Search:

`(event_id:("4697" "7045") OR (log_name:Autoruns AND event_data.Category:Services) ) AND event_data.CommandLine.keyword:/.*%[s|S][y|Y][s|S][t|T][e|E][m|M][r|R] [o|O][o|O][t|T]%\\[^\\]*\.exe/ AND -event_data.CommandLine:(*paexe* *psexesvc* *winexesvc* *remcomsvc*)`

`event_id:("4697" "7045")` is used to identify services being installed.
`log_name:Autoruns AND event_data.Category:Services` is used to identify auto start services detected by the Autoruns MS tool. `event_data.Category:Services` is used to limit the Autorun-derived documents to those only related to services
`-event_data.CommandLine:(*paexe* *psexesvc* *winexesvc* *remcomsvc*)` excludes services that interact with expected Windows executables inside the Windows folder.

![[Pasted image 20251012122303.png]]
---

## **TASK 5: CREATE A SEARCH TO IDENTIFY SUSPICIOUS CODE INJECTION**

Sysmon contains a **CreateRemoteThread** event (Event ID 8) that detects when a process creates a thread in another process. Malware usually do that so that the target process can load a malicious DLL (whose path is written in the virtual address space of the target process) or a malicious portable executable.
![[Pasted image 20251012122636.png]]
Search:

`event_id:8 AND source_name:"Microsoft-Windows-Sysmon"  AND -(event_data.SourceImage:"*\\VBoxTray.exe" AND event_data.TargetImage:"*\\csrss.exe")  AND -(event_data.StartFunction:EtwpNotificationThread AND event_data.SourceImage:"*\\rundll32.exe")`

![[Pasted image 20251012122830.png]]

---

## **TASK 6: CREATE A SEARCH TO IDENTIFY POSSIBLE PRIVILEGE ESCALATION VIA WEAK SERVICE PERMISSIONS**

As mentioned in this taskâ€™s description attackers will interact with the **sc** Windows executable in order to identify if a service has weak permissions and if they have any kind of privileged access over it.

If they have enough privileges, attackers may also attempt to specify an executable of their own to be executed by the insufficiently secure service. This can be done again through the sc executable and the config option (binPath =
Search:

`event_data.Image:"*\\sc.exe"  AND (event_data.CommandLine:(*start* *sdshow*) OR  (event_data.CommandLine:*config* AND event_data.CommandLine:*binPath*))  AND event_data.IntegrityLevel:Medium`

`event_data.IntegrityLevel:Medium` ensures that we donâ€™t get results from privileged users (such as admins) performing legitimate service tasks.

![[Pasted image 20251012123153.png]]

---

## **TASK 7: CREATE A SEARCH TO IDENTIFY POSSIBLE WINDOWS SESSION HIJACKING**

As already mentioned in this taskâ€™s description we can focus on any `tscon` invocation. More specifically, we are interested in any tscon invocation with SYSTEM-level privileges. 

A viable search to identify possible Windows session hijacking via the described attacker technique is the below.

Search:

`event_data.Image:"*\\tscon.exe" AND event_data.User:"NT AUTHORITY\\SYSTEM"`

Alternatively, you can use the following search : 
`event_data.Image:"*\\tscon.exe" AND (event_data.LogonId:0x3e7 OR event_data.SubjectLogonId:0x3e7 OR event_data.User:"NT AUTHORITY\\SYSTEM")`

![[Pasted image 20251012123814.png]]
---

## **TASK 8: CREATE A SEARCH TO IDENTIFY THE WHOAMI COMMAND BEING EXECUTED WITH SYSTEM PRIVILEGES**

It is quite trivial to create a search to detect the whoami command being executed with SYSTEM-level privileges.

Search:

`event_data.Image:"*\\whoami.exe" AND (event_data.LogonId:0x3e7 OR event_data.SubjectLogonId:0x3e7 OR event_data.User:"NT AUTHORITY\\SYSTEM")`

The LogonIds used in this and the previous tasks are usually met when SYSTEM-level access is involved.
![[Pasted image 20251012123932.png]]

---
## **TASK 9: CREATE A SEARCH TO IDENTIFY LSASS LOADING A LIBRARY NOT SIGNED BY MICROSOFT**

Sysmonâ€™s Event ID 7: Image loaded can be used to monitor the DLLs being loaded by a specific process. Thankfully this event contains information about the libraryâ€™s signature in its data (Signature entry).

Search:

`event_id:7 AND event_data.Image:"*\\lsass.exe" AND event_data.Signature:*Microsoft*`

![[Pasted image 20251012124044.png]]
## **Outcome**

By completing these tasks, analysts gain:

- Mastery of **ELK search syntax**.
    
- Ability to map attacker TTPs to log events.
    
- Practical detection rules for:
    - Failed logins.
    - Process masquerading.
    - Service abuse.
    - Code injection.
    - Privilege escalation.
    - RDP hijacking.
    - Credential dumping.
        

---

## **Conclusion**

ELK is a powerful SIEM stack enabling analysts to:
- Collect and normalize diverse logs.
- Detect attacker behaviors via search queries.
- Visualize activity for faster incident response.
    

This lab demonstrated how to **translate adversary behavior into ELK searches** aligned with MITRE ATT&CK techniques, strengthening intrusion detection capabilities.