
## title: "IR Report — Task 4: Suspicious services executing Windows-folder executables"  
author: "SOC / IR Analyst"  
date: 2025-10-14  
tags: [IR, ELK, Lucene, detection, services, persistence]
## Executive summary

Attackers sometimes drop malicious executables into the Windows directory (`%SystemRoot%`) to blend in, then register those executables as Windows services for persistence. The goal of this detection is to surface service creation/install events (Windows event IDs **7045** or **4697**) where the service command-line points to an executable located under the Windows folder — a high-risk indicator when the executable is not a known, signed, or expected component.

### Evidence

![[Pasted image 20251014114257.png]]` — Example search hits showing service creation events with command lines referencing executables under the Windows folder.
    
![[Pasted image 20251014114309.png]]` — Detailed event view showing the service creation / install and the full command-line path pointing into `%SystemRoot%`.
    

---

## Detection objective

Detect service creation/install events where the service command-line executes an `.exe` located inside the Windows folder (`%SystemRoot%`), which may indicate a malicious binary dropped into that folder and registered for persistence.

Primary signals:

- Event ID `7045` (Service installed) or `4697` (Service created)
- `event_data.CommandLine` (or equivalent field) contains an `.exe` path under `%SystemRoot%` (e.g., `C:\Windows\something.exe`)

Secondary signals to correlate:

- Binary not code-signed or hash not in allowlist
- New or unusual service name / display name
- File creation events (FileCreate) shortly before service creation
- Network connections from the host to suspicious domains shortly after service start
- Parent process that is not a legitimate installer (e.g., `cmd.exe`/`powershell.exe` instead of `msiexec.exe`/installer)

---

## Problems with original Lucene and quick fixes

Original query (as provided):

```
(event_id:"7045" OR event_id:"4697") AND event_data.CommandLine.keyword:/ .* %systemroot%\A\\]*\.exe/il
```

Issues:

- Regex formatting may be off for how Kibana indexes `event_data.CommandLine.keyword` (escape sequences, spacing).
- `%systemroot%` literal usage depends on ingestion — better to match `\\Windows\\` or allow `%systemroot%` expansion if normalized.
- Needs to be robust to backslash variants and to match any `.exe` under the Windows directory.
    

---

## Improved detection queries

### Lucene (Kibana) — robust

```
(event_id:"7045" OR event_id:"4697") AND event_data.CommandLine.keyword:(*\\Windows\\*.exe OR *%SystemRoot%\\*.exe)
```

> Use `.keyword` (or full command line field) to avoid tokenization issues and include both `C:\\Windows\\` and `%SystemRoot%` styles depending on how events are ingested.

### KQL (Kibana Query Language)

```
(event_id : 7045 or event_id : 4697) and (event_data.CommandLine.keyword : *\\Windows\\*.exe or event_data.CommandLine.keyword : *%SystemRoot%\\*.exe)
```

### Add checks for signer / new file

Combine with checks for file signature/hash or file creation time:

```
(event_id:"7045" OR event_id:"4697") AND event_data.CommandLine.keyword:(*\\Windows\\*.exe) AND (NOT file.hash:* OR NOT file.pe.signer:*)
```

### Example Elastic DSL

```json
{
  "query": {
    "bool": {
      "must": [
        { "terms": { "event_id": [7045, 4697] }},
        { "wildcard": { "event_data.CommandLine.keyword": "*\\Windows\\*.exe" }}
      ]
    }
  }
}
```

---

## How to interpret results (triage guidance)

For each hit:

1. Capture full `event_data.CommandLine`, `event_data.ServiceName`, `event_data.ServiceDisplayName`, and `event_data.Image` if present.
2. Check the file creation/modification timestamp and parent process that performed the write (FileCreate/FileCreateTime/ProcessCreate).
3. Query code signing (if available) and file hash reputation (VirusTotal). If unsigned and new, escalate.
4. Look for subsequent process activity, persistence (services entries in registry), scheduled tasks, and network connections.

Prioritize when: unsigned executable, service name is generic or suspicious, creation time closely precedes service creation, or the binary communicates externally.

---

## False positives & tuning

Potential benign cases:

- Legit installers that legitimately place service binaries in `%SystemRoot%` (rare, but possible).
- System updates or OEM components.

Tuning:

- Maintain allowlist of known vendor files in `C:\\Windows\\` (rare but possible).
- Suppress alerts for well-known signed Microsoft files (check `file.pe.signer` / signature fields).
- Add conditions that the binary was created in the last N days to focus on new suspicious persistence.

---

## IOC extraction (examples)

- Service names and display names.
- Full command-line paths under `C:\\Windows\\*\\*.exe` or `%SystemRoot%\\*.exe`.
- File hash and signer status.
- Parent process that created the file or registered the service.

---

## TTP mapping (MITRE ATT&CK)

- **T1543** Create or Modify System Process (service creation)
- **T1105** Ingress Tool Transfer (dropping binary into Windows folder.    
- **T1547** Boot or Logon Autostart Execution (service persistence)
- **T1036** Masquerading (binary named to blend with Windows)

---

## Immediate containment & triage playbook (brief)

1. Quarantine host and capture volatile evidence (memory, running services list).
2. Collect service registry entries and `sc.exe` details, binary file hash, and file timestamps.
3. Block remote domains / IPs associated with the binary and push file hash to EDR.
4. If confirmed malicious, remove service registration, delete binary, and reimage host (preferred when credentials or Lateral Movement suspected).
5. Rotate affected credentials and hunt for the same artifacts across estate.

---

## Forensic collection commands (quick)

**List services and binaries (PowerShell)**

```powershell
Get-WmiObject -Class Win32_Service | Select-Object Name, DisplayName, PathName, StartMode | Export-Clixml C:\forensics\services.xml
```

**Get service creation events (Event Viewer / EVTX)**

```powershell
Get-WinEvent -FilterHashtable @{LogName='System'; Id=7045; StartTime=(Get-Date).AddDays(-7)} | Export-Clixml C:\forensics\system_7045.xml
Get-WinEvent -FilterHashtable @{LogName='Security'; Id=4697; StartTime=(Get-Date).AddDays(-7)} | Export-Clixml C:\forensics\security_4697.xml
```

---

## Recommendations

1. Alert on service creations that reference `%SystemRoot%` executables and require enrichment (signer/hash) before auto-suppressing.
    
2. Enrich with file reputation and code-signing checks.
    
3. Create a follow-up hunt to search for recently created executables under `C:\\Windows\\` across the estate in the last 30 days.