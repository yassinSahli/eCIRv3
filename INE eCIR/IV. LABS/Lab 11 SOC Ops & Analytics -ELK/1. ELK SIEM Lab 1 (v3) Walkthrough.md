## Lab 
![[Pasted image 20251014115313.png]]
# Scenario

The organization you work for is evaluating a customized [ELK stack](https://www.elastic.co/elk-stack) as a SIEM solution to enhance its intrusion detection capabilities. The SOC manager tasked you with getting familiar with the ELK stack and its detection capabilities. He also tasked you with translating common attacker behavior into ELK searches.

**Note**: Credits to [Teymur Kheirkhabarov](https://twitter.com/HeirhabarovT) for the dataset this lab uses and some of the detection techniques covered.

# Learning Objectives

The learning objective of this lab, is to get familiar with ELK stack's architecture and detection capabilities.

# Recommended tools
- ELK
- Use a Firefox browser to connect to Kibana [**http://demo.ine.local:5601**](http://demo.ine.local:5601/)

## Initial Setup
We must, first specify the correct timestamp: 
![[Pasted image 20251014104450.png]]
The dataset we ingested is from 2018, so once we are connected to Kibana, first change the time picker to Last 15 years and then submit an empty search:
![[Pasted image 20251014104527.png]]
Solved.

Next, since we ingested a custom dataset, let's specify the **logstash** DB
![[Pasted image 20251014104548.png]]

## Task 1: Add any fields you see fit to enhance your understanding of the data


![[Pasted image 20251014104859.png]]

Add the following fields:
![[Pasted image 20251014105628.png]]

## Task 2: Create an actionable visualization
[!] NOT IMPORTANT AT THIS STAGE [!]
## Task 3: Create a search to identify files that are named like system processes

![[Pasted image 20251014110853.png]]

```
Lucene> event_data.Image:("svchost.exe" OR "Isass.exe" OR "winlogon.exe") AND NOT event_data.Image:("*\system32\\*""*\\syswow64\\*")
```

Let's analyze it even more: 
![[Pasted image 20251014111346.png]]
![[Pasted image 20251014111410.png]]

An `.xsl` (XML Stylesheet Language) file can **contain embedded scripting**, including **JScript or VBScript**.   When WMIC loads it, the Windows XML parser will **execute the script** inside it.

So effectively, this command can:
- Fetch a **malicious script** from a remote server.
- Execute it **locally with the privileges of the user** running the command.
- Be used to run arbitrary code: **a remote code execution (RCE)** vector.

Let's add more process names: (service.exe)
![[Pasted image 20251014111626.png]]
![[Pasted image 20251014111743.png]]
![[Pasted image 20251014111730.png]]
- `sekurlsa::logonpasswords` is a **Mimikatz** module/command used to dump Windows logon credentials (LSASS memory). It requires elevated/System privileges to succeed.
- Sysmon Event ID **10** (read from LSASS) and Event ID 1 (Process Create) showing unusual parent-child combos (cmd -> services.exe).

This looks like a Mimikatz credential-dump event (sekurlsa::logonpasswords): high confidence this is malicious activity
## Task 4: Create a search to identify suspicious services interacting with an executable from the Windows folder

Normally, legitimate services run from `C:\Windows\System32\` and are created by trusted installers or Windows itself.  

However, attackers often **drop malicious executables** inside the Windows folder to blend in, then register them as services for persistence

```
Lucene> (event_id:"7045" OR event_id:"4697") AND event_data.CommandLine.keyword:/ .* %systemroot%\A\\]*\.exe/il
```
- It finds **events where a service was created or installed (7045 or 4697)**
- Any service command line that runs an **executable (.exe)** from inside the **Windows directory** (`%systemroot%`).
- Combined, this will Detect **potentially malicious service creations** pointing to suspicious Windows executables
![[Pasted image 20251014114257.png]]
![[Pasted image 20251014114309.png]]


## Task 5: Create a search to identify the whoami command being executed with System privileges

```
Lucene> event_data.Image:"*\whoami.exe\\*" AND (event_data.User:"NT AUTHORITY\SYSTEM")
```

![[Pasted image 20251014114939.png]]
![[Pasted image 20251014114946.png]]
![[Pasted image 20251014114950.png]]