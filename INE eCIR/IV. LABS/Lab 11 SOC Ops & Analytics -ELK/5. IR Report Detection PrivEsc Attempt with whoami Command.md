## title: "IR Report — Task 5: whoami executed as SYSTEM"  
author: "SOC / IR Analyst"  
date: 2025-10-14  
tags: [IR, ELK, Lucene, detection, privilege-escalation, whoami]

## Executive summary

An ELK/Lucene search identified executions of `whoami.exe` running under the `NT AUTHORITY\SYSTEM` account. `whoami` itself is a benign diagnostic tool, but when executed as SYSTEM it can indicate an attacker has gained local SYSTEM privileges or abuse of built-in tools for discovery after privilege escalation. This detection surfaces `event_data.Image` pointing to `whoami.exe` where `event_data.User` equals `NT AUTHORITY\SYSTEM`.

### Evidence

![[Pasted image 20251014114939.png]]` — Search results showing `whoami.exe` execution events.
    
![[Pasted image 20251014114946.png]]` — Event details showing `event_data.User` = `NT AUTHORITY\\SYSTEM` and full command-line/metadata.
    
- `![[Pasted image 20251014114950.png]]` — Correlated process tree or additional context indicating elevated activity around the same timeframe.
    

---

## Detection objective

Detect executions of `whoami.exe` or equivalent identity-discovery commands executed as the `SYSTEM` account (NT AUTHORITY\SYSTEM). This helps surface post-exploitation discovery activity or privilege escalation events.

Primary signal:

- `event_data.Image` ends with `\\whoami.exe` (or contains `\\whoami.exe`) AND `event_data.User` equals `NT AUTHORITY\\SYSTEM`.
    

Secondary signals to correlate:

- Parent process (who launched `whoami`) — e.g., `psexec.exe`, `schtasks.exe`, `services.exe`, `cmd.exe`, `powershell.exe`, or suspicious service execution.
    
- Nearby privileged activity: creation of services, credential-dumping indicators, Lsass reads (Sysmon 10), adding admin accounts, scheduled tasks.
    
- Network connections or lateral movement activity shortly before/after execution.
    

---

## Original Lucene and improvements

Original provided query:

```
Lucene> event_data.Image:"*\whoami.exe\\*" AND (event_data.User:"NT AUTHORITY\SYSTEM")
```

This is close but may suffer from escaping and tokenization differences. Use `.keyword` for full-path fields and ensure backslashes are escaped correctly.

### Improved Lucene (Kibana)

```
event_data.Image.keyword:(*\\whoami.exe) AND event_data.User:"NT AUTHORITY\\SYSTEM"
```

### KQL equivalent

```
event_data.Image.keyword: *\whoami.exe and event_data.User : "NT AUTHORITY\SYSTEM"
```

### Elastic DSL example

```json
{
  "query": {
    "bool": {
      "must": [
        { "wildcard": { "event_data.Image.keyword": "*\\\\whoami.exe" }},
        { "term": { "event_data.User.keyword": "NT AUTHORITY\\SYSTEM" }}
      ]
    }
  }
}
```

---

## How to interpret hits (triage)

For each match:

1. Record `event_data.Image`, `event_data.CommandLine`, `event_data.ParentImage`, `event_data.ParentCommandLine`, `event_data.ProcessId`, `host.name`, and timestamps.
    
2. Identify parent process and check whether it is a legitimate system process or an attacker-controlled launcher (PsExec, scheduled task, service install, etc.).
    
3. Search for other SYSTEM-level commands in the same timeframe (e.g., `whoami`, `net user`, `sc`, `tasklist`, `taskkill`, `mimikatz`, `sekurlsa`).
    
4. Correlate with Sysmon/Evt IDs for service creation (7045), process injection, or LSASS reads (Sysmon 10).
    
5. If `whoami` was run as SYSTEM unexpectedly, treat as high priority: consider host compromise and escalate for containment and forensic capture.
    

---

## False positives & tuning

Possible benign causes:

- Automated system tools/scripts legitimately running under SYSTEM (patching, monitoring agents) that execute `whoami` for diagnostics.
    

Tuning:

- Maintain an allowlist for known maintenance tasks and signed vendor software that can legitimately run `whoami` as SYSTEM.
    
- Only alert when `whoami` as SYSTEM is accompanied by suspicious parent processes, recent privilege escalation events, or post-exploitation TTPs.
    

---

## Containment & triage playbook (brief)

1. If unexpected, isolate the host (EDR) and collect volatile evidence (memory image).
    
2. Capture process tree, event logs (Security, System, Application), and Sysmon logs for the timeframe.
    
3. Identify parent process and whether credential dumping or persistence actions occurred.
    
4. Block any discovered external C2 domains/IPs and create EDR hunts for the same parent/command across estate.
    
5. If compromise confirmed, reimage host and rotate credentials for affected accounts.
    

---

## Forensic collection commands (quick)

**Export Security events with whoami occurrences**

```powershell
Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime=(Get-Date).AddDays(-7)} | Where-Object { $_.Message -match "whoami.exe" } | Export-Clixml C:\forensics\whoami_events.xml
```

**Search Sysmon process create for whoami**

```powershell
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-Sysmon/Operational'; Id=1; StartTime=(Get-Date).AddDays(-7)} | Where-Object { $_.Message -match "whoami.exe" } | Export-Clixml C:\forensics\sysmon_whoami.xml
```

---

## Recommended detections & follow-ups

- Create a correlation alert: `whoami executed as SYSTEM` **AND** `parent not in allowlist` OR `presence of Sysmon 10 / credential dumping` → escalate to IR.
    
- Hunt for other SYSTEM-level discovery commands executed in the last 30 days and look for lateral movement artifacts.
    
- Add enrichment: host owner, business criticality, and whether endpoint has EDR active.
    

---

## Incident summary template (for ticket)

**Title:** whoami executed as NT AUTHORITY\SYSTEM — possible post-exploitation discovery  
**Time:** [first_seen] — [last_seen]  
**Host:** [hostname]  
**Evidence:** event_data.Image = [path\whoami.exe], event_data.User = NT AUTHORITY\SYSTEM, parent = [parent image], commandline = [commandline]  
**Actions taken:** Isolated host, collected memory, searched for credential dumping indicators, initiated estate hunt.  
**Status:** Investigation / Remediation recommended.