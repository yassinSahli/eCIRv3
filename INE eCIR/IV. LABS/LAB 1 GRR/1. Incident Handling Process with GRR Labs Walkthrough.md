#### **Scenario**: 
When it comes to responding to an incident on enterprise environments, time to respond and visibility are everything.
There will be incidents, when waiting until an IR team is deployed or remotely logging into each under-investigation endpoint and issuing numerous commands, won’t be the optimum response approach.
Suppose that, multiple incidents have been declared inside a heterogeneous enterprise network (Cisco / Fortinet / Alcatel etc..) and you are called to dig deeper and identify what is actually happening.
Luckily, the corporation has deployed GRR **(Google Rapid Response)** clients on its endpoints and subsequently, you will be able to have both a bird’s eye view of the network and on-demand access to crucial endpoint information.

	The list of affected endpoints (GRR client installed) is:
	- win10-server.els-child.eLS.local
	- jumpbox.els-child.eLS.local
	- xubuntu

**During the lab you will have the opportunity to detect (fileless) malware, stealthy
persistence techniques and privilege escalation attempts, on a heterogeneous and
enterprise-like network.**

#### **Objectives**
During the lab you will have the opportunity to detect (fileless) malware, stealthy
persistence techniques and privilege escalation attempts, on a heterogeneous and
enterprise-like network.
Don’t get discouraged, if you are not familiar with the attacks that you will detect during
this lab. Everything will be covered as the course progresses. Focus only on becoming
familiar with GRR’s capabilities.

#### **Hints**:
1. Common Windows processes that are being misused by attackers are notepad.exe
and calc.exe. More specifically, attackers usually spawn the aforementioned
processes and then, inject malicious code into their memory address space. Memory
analysis is required to identify what has been loaded into a process’ memory.
Luckily, GRR offers remote memory analysis, utilizing the Rekall framework.

2. On well-secured and fully patched environments, humans are usually the weak link
in the corporation’s security chain. Search for malicious Office documents, that may
have tricked the endpoint’s user into executing malicious code

#### **Network Configuration**
Incident Responder’s Subnet: 172.16.66.0/24
- Under-investigation endpoints’ subnet: 10.100.11.0/24

GRR server
- IP: 10.100.11.122
- Connection Type: VNC
- Use a Linux or Windows VNC client to connect to GRR-Server (10.100.11.122)
- Linux-based Machine: 
```
# vncviewer 10.100.11.122 
```

- Windows-based Machine: 
```
tightvncviewer.exe
Remote Host:10.100.11.122
```
A static route has been configured, so that the Incident Responder can interact with the
endpoints on the 10.100.11.0/24 subnet.

To log into the GRR administration panel (after you connect to the GRR server through
VNC as mentioned above):
1. Open a web browser
2. Navigate to localhost:8000
3. Submit the following credentials: admin/@nalyst


#### Task 1: win10-server.els-child.eLS.local Machine
1. Information Gathering using GRR: 
Step 1: List all the deployed GRR clients by clicking on the **Search box** and pressing nothing other than **Enter**
![[Pasted image 20250821085858.png]]
Output: 
![[Pasted image 20250821090108.png]]
Note: Do not start any IR activities, until all bullets turn **green**.

Step 2: Click on the first of the three lines then access the **win10-server.els-child.eLS.local** machine
![[Pasted image 20250821140406.png]]
Note: Click on **Full Details** to access more detailed representation of the acquired initial information.

Step 4: To start gathering important information about this endpoint, such as communications
with other endpoints, listening ports etc., you can utilize GRR flows. To do so, click on **Start
new flows.**
![[Pasted image 20250821140911.png]]

Step 5: Select the flow type you  want to focus on, for example to list all **Active Network Connections** on this endpoint, you should go to **Network -> Netstat** and press **Launch**

![[Pasted image 20250821141104.png]]

Step 6: To collect the results, you should click on Manage launched flows and then, click on the
launched flow.
![[Pasted image 20250821141244.png]]

Step 7: Network Results Analysis
Suspicious ``rundll32.exe`` established connection on **Port 81** with an intranet host 10.100.11.250 (Keep in mind, GRR Server IP: 10.100.11.122 -> .250 Considered INTRANET)
![[Pasted image 20250821141713.png]] --> `rundll32.exe` is a legitimate Windows process that normally runs locally to load and execute DLLs. However, it is unusual for `rundll32.exe` to establish outbound network connections. In this case, the process opened a connection on **Port 81** to an intranet host `10.100.11.250` 
	 --> The abnormality lies in `rundll32.exe` making **any** network connection at all.
	 --> Attackers often abuse it to execute malicious payloads while blending in as a trusted process.

[!] IN CASE NOT FOUND, RUN **Processes -> ListProcesses** and press **Launch** [!]

- You'll surely find it under **PID 5276**, since it is an active process currently running on the host.    
- While `rundll32.exe` is a legitimate Windows process, it typically runs only when invoked to load a specific DLL and then exits. It is not designed to persistently run in the background. Continuous execution or unexpected persistence of `rundll32.exe` may therefore indicate malicious activity or misuse.
- Furthemore, it is a process that is made to execute locally, since it's there's a remote connection established between the local machine and an external IP [10.100.11.250] it's certainly malicious activity  

Step 8: Let’s try and list every **Registry** under these locations (usually abused by attackers to trigger malware):
- HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows/CurrentVersion
- HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows/CurrentVersion/*

Click on Start new flows and then navigate to **Registry -> RegistryFinder**
![[Pasted image 20250821144409.png]]


The results will appear in the Manage launched flows area, It will take a while until the results reach the GRR server…

![[Pasted image 20250821164338.png]]

You will be taken to the Browse Virtual Filesystem, where you can investigate further. If you start a new flow, and specify: 
- HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows NT/CurrentVersion/* 

Investigate **RegistryFinder** the following result:
![[Pasted image 20250821164524.png]]
To investigate it further, you first locate it on the dropdown menu on the left part of the
screen, as follows.
![[Pasted image 20250821164611.png]]

That calc.exe entry is certainly suspicious. Investigate it further, by first double-clicking on
it and then, clicking the refresh button as you did previously. 

Once the latest results arrive, you will see the below: 

--> In kill chain methodology, this is what we call "Persistence Mechanism".

#### Task 2: JUMPBOX.ELS-CHILD.ELS.LOCAL Endpoint

[!] We need to get back to the "ALL MACHINES" first, by clicking on the search bar menu and searching for an empty string [!]

Step 1: List endpoint's running processes: **Start new flows > Processes > ListProcesses > Launch**
![[Pasted image 20250911133823.png]]

Step 2: You will see results similar to the below in the **Manage launched flows** area
![[Pasted image 20250911134004.png]]

Step 3: Analyse & Spot suspicious entries 
![[Pasted image 20250911134431.png]]
[!] What looks interesting is that calc.exe is running. Of course, it could be something benign,
but attackers commonly abuse calc.exe and notepad.exe processes to inject malicious code
in them [!]

In order for us to inspect if it's a legitimate process or not, we need a memory analysis tool.
GRR offers the **Remote Memory Analysis** Feature under the name **REKALL**.

Step 4: Start new flows >Memory >AnalyzeClientMemory > Rekall plugin 
**Configuration**
- Plugin: *idrmodules* (Targets  $ARGS specifically)
- $ARGS: *proc_regex = calc.exe*
![[Pasted image 20250911134828.png]]

In this case, we specified the ldrmodules Rekall plugin, targeted specifically at the calc.exe
process.


Step 5: You will see results similar to the below in the **Manage launched flows** area
![[Pasted image 20250911135532.png]]
![[Pasted image 20250911135627.png]]

Step 6: Analysis
Finally, if you go through everything that has been loaded, you should notice the following.
![[Pasted image 20250911135644.png]]
[!] System.Management.Automation.dll is actually the DLL responsible for every PowerShell
operation [!]

**The analysis shows that `calc.exe` has unexpectedly loaded System.Management.Automation.dll, the core PowerShell library, which confirms that malicious PowerShell code has been injected into the Calculator process.**

How this endpoint got infected in the first place, you may ask. Give the **Downloads** 
directory a closer look, in case something malicious has been downloaded and executed. 
![[Pasted image 20250911141435.png]]
The GRR client installer and a .xlsx file are included. Let’s give this .xlsx file a closer look: Download > Re-Collect from the client

![[Pasted image 20250911141534.png]]

Once re-collecting is done, browse to the directory again and simply click on Download
(126305 bytes), as follows. It will save it into the GRR server’s Download directory.
![[Pasted image 20250911141633.png]]

What you need to now is that .xlsx files = =  .zip files. So, let’s rename this file to .zip: 
![[Pasted image 20250911141649.png]]

Once you rename it, double-click on it. You will be presented with the below
![[Pasted image 20250911141751.png]]

Now, double-click the xl folder, then the activeX one and finally, drag and drop activeX1.bin
to the Downloads directory.
![[Pasted image 20250911141914.png]]
WHY ? WHY DID WE CHOOSE TO TARGET THE .BIN FILE ? 
The only file on the .xlsx file capable of running code is the .bin file. whereas the other files were just metadata, XML, or non-executable content, so focusing on it allowed us to identify the actual payload responsible for malicious execution.

Right-click on **Downloads** and then click **Open Terminal Here**.

Inside the terminal, execute:
``
```
# xxd activeX1.bin | more
```
![[Pasted image 20250911142056.png]]

The above means, that the .xlsx file contained a Flash Application, something common only
on malicious Office documents that leverage Flash vulnerabilities for malicious code
execution purposes.


This is the **magic header** for a **Flash (SWF) file**.
- `FWS` = ShockWave Flash (uncompressed).
- `CWS` would mean compressed SWF.

Inside the dump we see XML metadata (RDF/DC namespaces):
```
dc:format>application/x-shockwave-flash</dc:format>
<dc:title>Adobe Flex 4 Application</dc:title>
<dc:description>http://www.adobe.com/products/flex</dc:description>
```
==This code targets devices that have **Adobe Flex 4** installed.
This confirms the embedded object is actually a **Flash application (SWF)** disguised inside the `.xls`

*Attackers frequently embedded **Flash exploits** inside Office documents (usually Excel or Word) via ActiveX objects. When the victim opened the document, the Flash object could execute, often exploiting a vulnerability in Adobe Flash Player to gain code execution.

**Suspicious indicators**:
- Flash is obsolete and highly exploited — finding `application/x-shockwave-flash` inside an Office doc is a **red flag**.
- Attackers often used this exact method in the past to deliver **remote code execution exploits**.

*The above means, that the .xlsx file contained a Flash Application, something common only
on malicious Office documents that leverage Flash vulnerabilities for malicious code
execution purposes.*

**To conclude, the suspicious `.xls` file contains an embedded **Shockwave Flash (SWF) object disguised as `ActiveX1.bin`**, indicating an attempt to exploit Flash within Excel for code execution.**


#### Task 3: XUBUNTU Machine

Step 1: To list this endpoint’s running processes: Start new flows > Processes > ListProcesses > Launch.
![[Pasted image 20250911150204.png]]
Step 2: You will see results similar to the below in the Manage launched flows area
![[Pasted image 20250911150322.png]]

Step 3: Analyse & Investigate
- There' s a process under the name `bleidi` that was run by `elsuser` and run by root privileged rights, which is strange!  
![[Pasted image 20250911151554.png]]

- This binary (bleidi), is being executed with elsuser privileges and then, with root ones.
Something is definitely strange…

Step 4: Deep Inspection

To give this binary a closer look (it has been re-collected for you this time), Browse Virtual Filesystem > fs > os > home > elsuser > Downloads, Then click on `bleidi` binary and finally click on HexView.
![[Pasted image 20250911152957.png]]

If you do so, and navigate to the sixth page of the HexView, you will notice the below.
![[Pasted image 20250911153015.png]]
It looks like bleidi is a malicious binary, trying to perform local privilege escalation and
provide the attacker with a root shell.