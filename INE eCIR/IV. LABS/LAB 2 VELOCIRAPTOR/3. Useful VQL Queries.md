
---
## PowerShell ScriptBlock / Operational log hunting (rundll32 / mshtml / WinHttp)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(
  filename='c:/windows/system32/winevt/Logs/Microsoft-Windows-PowerShell%4Operational.evtx'
)
WHERE EventData CONTAINS "rundll32"
   OR EventData CONTAINS "mshtml"
   OR EventData CONTAINS "WinHttp.WinHttpRequest"
   OR EventData CONTAINS "Invoke-"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Windows Security Event log — suspicious logons (4624/4625/4672)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Security.evtx')
WHERE EventData CONTAINS "4624" OR EventData CONTAINS "4625" OR EventData CONTAINS "4672"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Recently created services (persistence via service creation)
```sql
SELECT *
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/System.evtx')
WHERE EventData CONTAINS "Service Control Manager"
  AND (EventData CONTAINS "created service" OR EventData CONTAINS "CreateService")
ORDER BY System.TimeCreated.SystemTime DESC
```

## List currently running processes (basic triage)
```sql
SELECT PID, PPID, Name, Path, CommandLine, StartTime
FROM pslist()
ORDER BY StartTime DESC
```

## Process tree for suspicious process (parent ↔ children)
```sql
SELECT PID, PPID, Name, CommandLine
FROM pslist()
WHERE PID = <suspicious_pid>
UNION
SELECT PID, PPID, Name, CommandLine FROM pslist() WHERE PPID = <suspicious_pid>
```

## Network connections (outgoing) — find external C2 / beacons
```sql
SELECT Timestamp, LocalAddress, LocalPort, RemoteAddress, RemotePort, ProcessName, PID
FROM netstat()
WHERE RemoteAddress != '127.0.0.1' 
  AND RemoteAddress NOT LIKE '10.%' 
  AND RemoteAddress NOT LIKE '172.16.%' 
  AND RemoteAddress NOT LIKE '192.168.%'
ORDER BY Timestamp DESC
```

## Listening ports (identify uncommon services)
```sql
SELECT LocalAddress, LocalPort, ProcessName, PID
FROM netstat()
WHERE State = 'LISTEN'
ORDER BY LocalPort
```

## DNS cache lookups (recently resolved domains)
```sql
-- Use the DNSCache artifact if available; otherwise adapt to your deployment's DNS artifact
SELECT * FROM DNSCache()
```

## Scheduled Tasks (created / modified recently)
```sql
SELECT TaskName, Author, Actions, LastRunTime
FROM scheduled_tasks()
ORDER BY LastRunTime DESC
```

## Registry Run / autostart keys (common persistence locations)
```sql
SELECT KeyPath, Name, Data
FROM registry_key("HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run")
UNION
SELECT KeyPath, Name, Data
FROM registry_key("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run")
```

## Services with suspicious binary path (Temp / AppData)
```sql
SELECT Name, DisplayName, ImagePath
FROM services()
WHERE ImagePath CONTAINS "\\Temp\\" OR ImagePath CONTAINS "\\AppData\\"
ORDER BY Name
```

## Files created/modified in last N hours (new binaries)
```sql
SELECT FullPath, Size, MFTEntry, CreatedTime, ModifiedTime
FROM parse_mft(filename='C:/')
WHERE CreatedTime >= ago(24h) OR ModifiedTime >= ago(24h)
ORDER BY CreatedTime DESC
```

## Executables in user temp and suspicious dirs (droppers)
```sql
SELECT FullPath, Size, SHA256
FROM glob(paths=["C:/Users/*/AppData/Local/Temp/*.exe","C:/Users/*/AppData/Local/Temp/*.dll","C:/Windows/Temp/*.exe"])
```

## Detect in-memory injection / reflective-loading indicators (rundll32 / mshta / mshtml)
```sql
SELECT PID, Name, CommandLine
FROM pslist()
WHERE CommandLine CONTAINS "rundll32" OR CommandLine CONTAINS "mshta" OR CommandLine CONTAINS "mshtml" OR CommandLine CONTAINS "javascript:"
ORDER BY PID
```

## Loaded modules / DLLs for a suspicious process
```sql
SELECT PID, Name, ModuleName, ModulePath
FROM modules()
WHERE PID = <suspicious_pid>
ORDER BY ModuleName
```

## Inspect browser history / cached javascript retrievals (HTTP GETs to suspicious IPs)
```sql
SELECT url, last_visit_time, title
FROM browser_history()
WHERE url CONTAINS "10.100.11.250" OR url CONTAINS "http://"
ORDER BY last_visit_time DESC
```

## Look for commonly abused command-line tools (certutil, bitsadmin, powershell, rundll32)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Microsoft-Windows-PowerShell%4Operational.evtx')
WHERE EventData CONTAINS "certutil" OR EventData CONTAINS "bitsadmin" OR EventData CONTAINS "rundll32" OR EventData CONTAINS "Invoke-WebRequest" OR EventData CONTAINS "Invoke-Expression"
UNION
SELECT CommandLine, ProcessId, Timestamp FROM process_creation() WHERE CommandLine CONTAINS "certutil" OR CommandLine CONTAINS "bitsadmin" OR CommandLine CONTAINS "rundll32"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Sysmon-style process creation events (if Sysmon present)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Microsoft-Windows-Sysmon%4Operational.evtx')
WHERE EventData CONTAINS "ProcessCreate"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Search PowerShell transcripts / module logs on disk
```sql
SELECT FullPath, Size
FROM glob(paths=["C:/ProgramData/Microsoft/Windows/PowerShell/PSReadline/*","C:/Users/*/AppData/Local/Temp/*.ps1"])
```

## Identify suspicious network downloads (recent .dll / .exe / .ps1)
```sql
SELECT FullPath, Size, SHA256, CreatedTime
FROM glob(paths=["C:/Users/*/Downloads/*","C:/Windows/Temp/*"])
WHERE FullPath CONTAINS ".dll" OR FullPath CONTAINS ".exe" OR FullPath CONTAINS ".ps1"
ORDER BY CreatedTime DESC
```

## Collect running services + service binary hashes (IOC comparison)
```sql
-- If JOIN not supported, run services() then filehashes() against discovered ImagePath(s)
SELECT Name, ImagePath, SHA256
FROM services()
JOIN filehashes() ON services().ImagePath = filehashes().Path
```

## Enumerate scheduled task XMLs for suspicious commands / URLs
```sql
SELECT TaskName, xml
FROM scheduled_tasks(include_xml=true)
WHERE xml CONTAINS "http://" OR xml CONTAINS "powershell" OR xml CONTAINS "rundll32"
```

## Hunt for credential dumping indicators (LSASS access / suspicious process access)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Security.evtx')
WHERE EventData CONTAINS "Process access" OR EventData CONTAINS "lsass.exe"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Detect persistence in `Startup` folders
```sql
SELECT FullPath, Size, Created, Modified
FROM glob(paths=["C:/Users/*/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup/*"])
ORDER BY Created DESC
```

## Hunt WMI event subscriptions (stealth persistence)
```sql
SELECT *
FROM wmi_event_consumers()
```

## Enumerate auto-start extensibility points (ASEPs)
```sql
SELECT KeyPath, Name, Data
FROM registry_key(globs=[
  "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run*",
  "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run*",
  "HKLM\\System\\CurrentControlSet\\Services",
  "HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Userinit"
])
```

## Detect DLL hijacking opportunities (unquoted paths, writable dirs)
```sql
SELECT Name, ImagePath
FROM services()
WHERE ImagePath LIKE '"% %"' AND NOT ImagePath LIKE '"%'
```

## Search for encoded / obfuscated PowerShell (`-enc`, `frombase64string`)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Microsoft-Windows-PowerShell%4Operational.evtx')
WHERE EventData CONTAINS "-enc" OR EventData CONTAINS "frombase64string"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Look for suspicious parent-child process chains (lolbins)
```sql
SELECT PID, PPID, Name, CommandLine
FROM pslist()
WHERE (PPID IN (SELECT PID FROM pslist() WHERE Name="explorer.exe"))
AND (Name="powershell.exe" OR Name="cmd.exe" OR Name="wscript.exe" OR Name="cscript.exe" OR Name="mshta.exe")
```

## Find credential dumping tools (mimikatz, procdump, sekurlsa)
```sql
SELECT Name, CommandLine, PID
FROM pslist()
WHERE CommandLine CONTAINS "mimikatz"
   OR CommandLine CONTAINS "procdump"
   OR CommandLine CONTAINS "sekurlsa"
```

## Audit LSASS access attempts
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Security.evtx')
WHERE EventData CONTAINS "lsass.exe" AND EventData CONTAINS "PROCESS_ACCESS"
```

## SMB / RDP brute force attempts
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Security.evtx')
WHERE EventData CONTAINS "4625" AND (EventData CONTAINS "RDP" OR EventData CONTAINS "SMB")
ORDER BY System.TimeCreated.SystemTime DESC
```

## Active network shares and open sessions
```sql
SELECT *
FROM net_sessions()
```

## Detect lateral movement tools (PsExec, WMIExec, WinRM)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Security.evtx')
WHERE EventData CONTAINS "psexec" OR EventData CONTAINS "winrm" OR EventData CONTAINS "wmic"
```

## Monitor file writes to sensitive directories (system32, drivers)
```sql
SELECT FullPath, Size, CreatedTime, ModifiedTime
FROM parse_mft(filename='C:/Windows/System32/')
WHERE CreatedTime >= ago(12h) OR ModifiedTime >= ago(12h)
ORDER BY CreatedTime DESC
```

## Identify unsigned binaries in system folders
```sql
SELECT FullPath, Size, SHA256, SigCheck
FROM glob(paths=["C:/Windows/System32/*.exe","C:/Windows/System32/*.dll"])
WHERE SigCheck = "Unsigned"
```

## Suspicious autoruns in Registry Image File Execution Options (IFEO)
```sql
SELECT KeyPath, Name, Data
FROM registry_key(globs=["HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\*"])
```

## Look for persistence via AppInit DLLs
```sql
SELECT KeyPath, Name, Data
FROM registry_key(globs=["HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows"])
WHERE Name="AppInit_DLLs"
```

## Capture clipboard content (detect exfil staging)
```sql
SELECT * FROM clipboard()
```

## Detect compression/exfil tools (rar, 7z, winzip)
```sql
SELECT Name, CommandLine, PID
FROM pslist()
WHERE CommandLine CONTAINS "7z" OR CommandLine CONTAINS "rar" OR CommandLine CONTAINS "zip"
```

## Search recent PowerShell download commands (`IEX`, `DownloadString`)
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Microsoft-Windows-PowerShell%4Operational.evtx')
WHERE EventData CONTAINS "Invoke-Expression" OR EventData CONTAINS "DownloadString" OR EventData CONTAINS "Invoke-WebRequest"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Detect Registry modifications to Disable AV / Defender
```sql
SELECT KeyPath, Name, Data
FROM registry_key(globs=[
  "HKLM\\Software\\Policies\\Microsoft\\Windows Defender\\*",
  "HKLM\\Software\\Microsoft\\Windows Defender\\*"
])
WHERE Data CONTAINS "0"
```

## Suspicious drivers installed recently
```sql
SELECT Name, DisplayName, ImagePath
FROM services()
WHERE StartType="KernelDriver" OR ServiceType="FileSystemDriver"
```

## Detect LOLBAS usage in Event Logs
```sql
SELECT EventData, System.TimeCreated.SystemTime
FROM parse_evtx(filename='c:/windows/system32/winevt/Logs/Security.evtx')
WHERE EventData CONTAINS "certutil"
   OR EventData CONTAINS "bitsadmin"
   OR EventData CONTAINS "wmic"
   OR EventData CONTAINS "regsvr32"
   OR EventData CONTAINS "mshta"
ORDER BY System.TimeCreated.SystemTime DESC
```

## Collect prefetch entries for recently executed binaries
```sql
SELECT * FROM prefetch()
ORDER BY RunCount DESC
```

## Detect persistence via Office Add-ins
```sql
SELECT FullPath, Size, CreatedTime
FROM glob(paths=["C:/Users/*/AppData/Roaming/Microsoft/Word/STARTUP/*","C:/Users/*/AppData/Roaming/Microsoft/Excel/XLSTART/*"])
```

## Detect named pipes used for C2
```sql
SELECT Name, State, PID
FROM handles()
WHERE Name CONTAINS "pipe"
```

## Look for anomalous parent/child mismatch (Office spawning PowerShell)
```sql
SELECT a.PID, a.Name, a.CommandLine, b.Name AS ParentName
FROM pslist() a
JOIN pslist() b ON a.PPID = b.PID
WHERE (b.Name LIKE "%winword%" OR b.Name LIKE "%excel%") AND (a.Name="powershell.exe" OR a.Name="cmd.exe")
```

---

### Extra IR heuristics
- **Persistence focus**: registry keys, scheduled tasks, WMI, services.  
- **Defense evasion**: AV registry keys, obfuscated PowerShell, unsigned binaries.  
- **Credential access**: LSASS memory access, procdump, mimikatz.  
- **Lateral movement**: PsExec, WMI, RDP logons.  
- **Exfiltration**: compression tools, suspicious network traffic, clipboard scraping.  
- **Detection strategy**:  
  - Start broad (pslist, netstat, logs)  
  - Narrow with keyword hunting (`WHERE EventData CONTAINS "rundll32"`)  
  - Pivot IoCs across logs, processes, network, registry.
---

