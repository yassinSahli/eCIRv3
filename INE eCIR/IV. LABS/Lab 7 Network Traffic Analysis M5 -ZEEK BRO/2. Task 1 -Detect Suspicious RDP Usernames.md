## **Objective**

Analyze RDP traffic in `RDP-004.pcap` and create a **Bro (Zeek) script** that alerts whenever an RDP connection is initiated with a username **different than “admin”**.
## **Step 1 – Inspect the RDP Event**

First, examine the built-in RDP event handler to understand what Bro captures.

`cat /opt/bro/share/bro/base/bif/plugins/Bro_RDP.events.bif.bro`
![[Pasted image 20250927173731.png]]
You will notice the `rdp_connect_request` event, which extracts two important values:

- **Connection metadata**
    
- **Cookie string** (often the username)

## **Step 2 – Create a New Bro Script**

Navigate to your home directory and create a script file:

`cd ~ touch test.bro vim test.bro`

Inside `test.bro`, start with a minimal script to print observed usernames:

`@load base/protocols/rdp  event rdp_connect_request(c: connection, cookie: string) {     print cookie; }`

Run it against the RDP PCAP:

`bro -b -r PCAPs/RDP-004.pcap test.bro`

- **`-b`** → prevents auto-loading all base scripts.
    
- **`-r`** → runs Bro against an offline PCAP file.
    

You should see the usernames printed in the terminal.
![[Pasted image 20250927174056.png]]
## **Step 3 – Add More Context**

Let’s enhance the script to also print the **source IP** and **timestamp**:

`@load base/protocols/rdp  event rdp_connect_request(c: connection, cookie: string) {     local start_time = strftime("%Y-%m-%d %H:%M:%S", c$start_time);     print fmt("New RDP Request from: %s at %s by user %s",               c$id$orig_h, start_time, cookie); }`

Run again:

`bro -b -r PCAPs/RDP-004.pcap test.bro`

Now you’ll see detailed connection information for each RDP request.
![[Pasted image 20250927174205.png]]
## **Step 4 – Add Detection Logic**

To meet the lab objective, we must **alert if the username ≠ “admin”**.  
This is where Bro’s **Notice Framework** comes in.

Final script:

`@load base/protocols/rdp @load base/frameworks/notice  export {     redef enum Notice::Type += { Suspicious_RDP }; }  event rdp_connect_request(c: connection, cookie: string) {     if (cookie != "admin") {         local start_time = strftime("%Y-%m-%d %H:%M:%S", c$start_time);         local message = fmt("New RDP Request from: %s at %s by user %s",                             c$id$orig_h, start_time, cookie);         NOTICE([$note=Suspicious_RDP, $msg=message]);     } }`

Run it again:

`bro -b -r PCAPs/RDP-004.pcap test.bro`
![[Pasted image 20250927174414.png]]
![[Pasted image 20250927174348.png]]
## **Step 5 – Automate Script Loading**

Instead of manually specifying `test.bro` every time, you can configure Bro to always load your custom scripts.

`sudo mkdir -p /opt/bro/share/bro/policy/custom-scripts sudo cp test.bro /opt/bro/share/bro/policy/custom-scripts/ sudo touch /opt/bro/share/bro/policy/custom-scripts/__load__.bro`

Inside `__load__.bro`, add:

`@load ./test.bro`

Finally, edit `local.bro`:

`sudo vim /opt/bro/share/bro/site/local.bro`

Append this line:

`@load custom-scripts`

Now run Bro with:

`sudo bro -r PCAPs/RDP-004.pcap local`
![[Pasted image 20250927174520.png]]
This ensures **all custom scripts** in your `custom-scripts/` directory are automatically loaded.

---

## **Outcome**

- Bro now automatically alerts on **RDP logins using non-admin usernames**.
    
- Alerts are written to **notice.log**, making monitoring easier and scalable.