## **Scenario**

The organization you work for is considering deploying **Bro (now known as Zeek)** to strengthen its network traffic monitoring and incident response capabilities.

Your IT Security Manager has provided you with several **PCAP files containing malicious traffic**. Your mission is to:

- Explore Bro‚Äôs extensive **logging and analysis features**.
    
- Write **custom detection scripts** and **signatures** to identify threats.
    
- Practice real-world network forensic techniques with Bro.
    

A test Bro instance has already been set up and is waiting for you to connect and begin the analysis.

---

## **Learning Objectives**

By completing this lab, you will:

- Understand the **differences between Bro/Zeek and traditional IDS systems** (like Suricata).
    
- Learn to navigate and interpret Bro‚Äôs **connection, DNS, HTTP, SSL, and notice logs**.
    
- Write **Bro scripts** to detect suspicious behaviors (RDP abuse, beaconing, long-lived RAT sessions).
    
- Learn how to **extend Bro‚Äôs functionality** using the scripting and signature frameworks.
    
- Detect advanced threats such as:
    
    - **SSL certificate abuse**
        
    - **Domain Generation Algorithms (DGAs)**
        
    - **Beaconing malware**
        
    - **ZeroAccess peer-to-peer botnets**


## **Introduction to Bro (Zeek)**

### What is Bro?

- An **open-source network traffic analyzer** designed for **in-depth inspection**.
    
- Goes beyond traditional IDS by providing:
    
    - **Extensive protocol analysis** (HTTP, DNS, FTP, SMTP, SSH, SSL, etc.).
        
    - **Comprehensive logging** (connection, DNS, HTTP, FTP, SMTP, etc.).
        
    - **Scripting language** for creating custom detection logic.
        
    - **Passive monitoring** (via libpcap) and **offline PCAP analysis**.
        

### Key Capabilities

- Logging of **every connection** with metadata.
    
- **Application-layer analysis** independent of ports.
    
- **File content inspection** (e.g., extracting transferred files).
    
- **Scripting framework** (event-driven, domain-aware, stateful).
    
- **Signature framework** (Snort-style low-level matching, if needed).
    
- **Cluster mode** support for large-scale deployments.
    

---

## **Core Concepts**

### Bro Architecture

![[Pasted image 20250927164259.png]]

- **Event Engine**: Converts packet streams into **events** (e.g., `http_request`, `dns_query`).
    
- **Script Interpreter**: Executes handlers written in Bro scripts to apply policy logic (what to log, when to alert).
    
![[Pasted image 20250927165349.png]]
### Bro Logs

By default, Bro generates multiple logs. Some common ones:

- `conn.log` ‚Üí IP/TCP/UDP/ICMP metadata.
    
- `dns.log` ‚Üí DNS queries and responses.
    
- `http.log` ‚Üí Full HTTP requests/responses.
    
- `ssl.log` ‚Üí SSL/TLS certificate details.
    
- `weird.log` ‚Üí Unexpected or malformed traffic.
    
- `notice.log` ‚Üí Security alerts (from scripts).
    

If we take, for example, the http.log Bro log, it includes numerous useful information such
as:
‚Ä¢ host: HTTP domain/IP
‚Ä¢ uri: HTTP URI
‚Ä¢ referrer: HTTP request referrer
‚Ä¢ user_agent: Client user agent
‚Ä¢ status_code: HTTP status code


Note that in its default setup, Bro will gzip compress log files every passing hour. The old
logs will be moved into a directory with a YYYY-MM-DD format. In the case of dealing with
compressed logs, you can use alternative tools such as gzcat to print logs or zgrep to search
in them.

we can use native Unix commands
such as cat or grep. However, Bro offers a custom tool to deal with log files called ‚Äúbro-cut‚Äù.
The ‚Äúbro-cut‚Äù utility reads Bro log files on standard input using pipelines or stream
redirections and outputs only the specified columns to standard output. For example, when
dealing with a http.log file, we can output the hostname only, as follows.
üëâ Use `bro-cut` to filter logs:

`cat http.log | bro-cut host uri user_agent`

### Bro Scripts

- Written in Bro‚Äôs scripting language (event-based).
    
- Allow you to define **custom detection logic** (e.g., alert on abnormal usernames in RDP).
    

### Bro Signatures

- Snort-like syntax for low-level matching.
    
- Useful for detecting malware fingerprints (e.g., ZeroAccess).