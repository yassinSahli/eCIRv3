# Vulnerability Finding: Red Team TTPs Translated into Splunk Searches

**Endpoint:** `Wayne Enterprises Network`  
**Date Identified:** 06/10/2025  
**Investigator:** Mr. Yassine SAHLI  

---

## Description

During the red team exercise, several Tactics, Techniques, and Procedures (TTPs) were provided. Using Splunk, these TTPs were translated into targeted searches to identify potential indicators of compromise (IOCs) across endpoints.  

Key findings include:

1. **Malicious USB / Removable Media Detection:**  
   - Using Sysmon logs and registry logs, inserted removable devices were identified by drive letters and the `friendlyname` field.  
   - Host **we8105desk.waynecorpinc.local** was found executing suspicious commands from the D: drive.  

2. **Computer-Generated Domain Names (DGA):**  
   - Analysis of DNS queries revealed domains likely generated algorithmically, excluding legitimate Microsoft and network service domains.  
   - Potential C2 communication was identified through anomalous Shannon entropy in domain names.  

3. **Malicious VBS Files Execution:**  
   - Sysmon logs indicated execution of `.vbs` files with abnormal parent and child process chains, consistent with red team malware deployment.  

4. **Mature Ransomware Activity Detection:**  
   - Activity involving `vssadmin.exe` with command lines attempting to delete Volume Shadow Copies (VSS) was detected, indicative of mature ransomware behavior.  

5. **Code Obfuscation Detection:**  
   - Long command lines were analyzed as potential indicators of obfuscated scripts and malware execution.  

---

## Impact

- **Endpoint Compromise:** Identified hosts show signs of malicious activity via removable media, obfuscated scripts, or ransomware preparation.  
- **Data Loss / Disruption Risk:** Deletion of shadow copies or execution of malware may lead to data encryption or loss.  
- **Network Reconnaissance and C2 Communications:** Detection of DGA domains indicates potential external command-and-control interactions.  
- **Medium to High Risk:** While no active encryption was confirmed, the environment demonstrates vulnerabilities that could be leveraged for ransomware deployment.

---

## Evidence

1. **Malicious USB Detection**  
   - Host: `we8105desk.waynecorpinc.local`  
   - Suspicious CommandLines:  
     ```
     "C:\Program Files (x86)\Internet Explorer\iexplore.exe" -nohome
     "C:\Program Files (x86)\Microsoft Office\Office14\WINWORD.EXE" /n /f "D:\Miranda_Tate_unveiled.dotm"
     ```  
   ![[Pasted image 20251004195810.png]]  
   ![[Pasted image 20251004195631.png]]  

2. **Computer-Generated Domains (DGA)**  
   - Suspicious domains detected with high Shannon entropy:  
     ![[Pasted image 20251006141715.png]]  

3. **Malicious VBS Execution**  
   - Obfuscated scripts identified in Sysmon logs:  
     ```
     *.vbs files with ParentCommandLine or CommandLine entries
     ```  
   ![[Pasted image 20251006142105.png]]  

4. **Mature Ransomware Indicators**  
   - `vssadmin.exe` attempting to delete shadows:  
     ```
     CommandLine="*vssadmin*" CommandLine="*Delete *" CommandLine="*Shadows*"
     ```  
   ![[Pasted image 20251006141934.png]]  

5. **Code Obfuscation Detection**  
   - Excessively long command lines as potential indicators of obfuscation:  
     ![[Pasted image 20251006142029.png]]  

---

## MITRE ATT&CK Mapping

- **Execution**  
  - **T1059 – Command and Scripting Interpreter**: Execution of `.vbs` scripts.  
- **Persistence**  
  - **T1091 – Replication Through Removable Media**: Malicious files executed via USB devices.  
- **Defense Evasion**  
  - **T1140 – Deobfuscate/Decode Files or Information**: Long or obfuscated command lines executed.  
  - **T1490 – Inhibit System Recovery**: Ransomware attempting to delete shadow copies.  
- **Command and Control**  
  - **T1496 – Domain Generation Algorithms**: Detection of computer-generated domains.  

---

## Recommendation

**Immediate Response:**  
- Isolate affected endpoints (e.g., `we8105desk.waynecorpinc.local`) and removable media.  
- Capture system and network logs for further forensic analysis.  

**Remediation:**  
- Remove malicious `.vbs` scripts and suspicious files from endpoints.  
- Restore affected systems using verified backups.  
- Block detected DGA domains in network and DNS filtering solutions.  

**Preventive Measures:**  
- Implement strict USB device usage policies and endpoint control.  
- Deploy advanced EDR with script/command line monitoring to detect obfuscation.  
- Monitor shadow copy manipulations and alert on `vssadmin` deletions.  

**Monitoring:**  
- Configure Splunk alerts for DGA domain queries, long command lines, and VSS deletions.  
- Review logs for repeated indicators of removable media abuse and obfuscated code.  

---

**Severity:** Medium-High  
**CVSSv3.1 Score:** 7.5 – Indicators of compromise detected with potential for ransomware escalation and data loss.